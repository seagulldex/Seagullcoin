<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trading - SGLCN-X20</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="header.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .green { color: green; }
    .red { color: red; }
    .orderbook-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .orderbook-table th,
    .orderbook-table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: right;
    }
    .orderbook-header {
      font-weight: bold;
      margin-top: 20px;
    }
    /* Scroll container for the orderbook */
    .orderbook-scroll {
      max-height: 400px;   /* Set desired max height */
      overflow-y: auto;    /* Vertical scrollbar if content overflows */
      border: 1px solid #ccc;
      margin-top: 10px;
      border-radius: 4px;
    }
    .trade-box {
  margin-top: 30px;
  padding: 20px;
  background-color: #000;
  color: #fff;
  border: 2px solid #444;
  border-radius: 16px;
  box-shadow: 0 0 12px rgba(255, 255, 255, 0.2);
  max-width: 400px;
  font-family: 'Segoe UI', sans-serif;
}

.trade-box input {
  width: 100%;
  padding: 10px;
  margin-top: 8px;
  margin-bottom: 12px;
  border: none;
  border-radius: 12px;
  background-color: #222;
  color: white;
  font-size: 1em;
}

.trade-box button {
  width: 100%;
  padding: 12px;
  border: none;
  background-color: #0af;
  color: white;
  font-weight: bold;
  font-size: 1em;
  border-radius: 12px;
  cursor: pointer;
  transition: background 0.3s;
}

.trade-box button:hover {
  background-color: #09c;
}

  </style>
</head>
<body>
  <header style="padding: 10px;">
    <span id="wallet-indicator" class="red" title="Click to login" onclick="startLoginFlow()">ðŸ”´ Login</span>
    <button id="logout-btn" style="display:none; margin-left: 10px;">Logout</button>
  </header>
  
  <header>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="stake.html">Stake</a></li>
         <li><a href="https://sglcn-x20-api.glitch.me/SeagullmansionsV2.html" target="_blank">SGLMN V2 (mint)</a></li>
        <li><a href="profile.html">Profile</a></li>
      </ul>
    </nav>
  </header>

  <main style="padding: 20px;">
    <h1>SeagullCoin Dex</h1>
    <div id="current-price">
      Median Price: <span id="price-value">Loading...</span> SGLCN-X20
    </div>
    
    <h2>Price Chart (SGLCN/XRP)</h2>
<div>
  <label for="timeframe">View:</label>
  <select id="timeframe" onchange="loadChartData()">
    <option value="1D">Daily</option>
    <option value="1W">Weekly</option>
    <option value="1M" selected>Monthly</option>
    <option value="ALL">All Time</option>
  </select>
</div>
<canvas id="priceChart" height="150" style="max-width: 100%; margin-bottom: 40px;"></canvas>

<div id="price-display">
  <strong>1 SGLCN = <span id="sglcn-price">Loading...</span> XRP</strong>
</div>

    
    <div id="orderbook">
      <div class="orderbook-header">Order Book</div>
      <div class="orderbook-scroll">
        <table class="orderbook-table" aria-label="Order Book">
          <thead>
            <tr>
              <th class="green">Buy Price (XRP)</th>
              <th class="green">Amount (SGLCN)</th>
              <th class="red">Sell Price (XRP)</th>
              <th class="red">Amount (SGLCN)</th>
            </tr>
          </thead>
          <tbody id="orderbook-body">
            <!-- JavaScript will populate this -->
          </tbody>
        </table>
      </div>
    </div>
    
    <div class="trade-box">
  <h3>Place Buy Offer</h3>
  <label for="buy-price">Price per SGLCN (XRP)</label>
  <input type="number" id="buy-price" placeholder="e.g. 0.5" step="0.000001" />

  <label for="buy-amount">Amount of SGLCN</label>
  <input type="number" id="buy-amount" placeholder="e.g. 100" step="1" />

  <button onclick="placeBuyOrder()">Submit Buy Offer</button>
</div>

    
  </main>

  <script>
    function updateWalletStatus() {
      const wallet = localStorage.getItem('xumm_wallet_address');
      const indicator = document.getElementById('wallet-indicator');
      const logoutBtn = document.getElementById('logout-btn');
      if (wallet) {
        indicator.textContent = 'ðŸŸ¢ Connected';
        indicator.classList.remove('red');
        indicator.classList.add('green');
        indicator.title = 'Logged in';
        indicator.onclick = null;
        logoutBtn.style.display = 'inline-block';
      } else {
        indicator.textContent = 'ðŸ”´ Login';
        indicator.classList.remove('green');
        indicator.classList.add('red');
        indicator.title = 'Click to login';
        indicator.onclick = startLoginFlow;
        logoutBtn.style.display = 'none';
      }
    }

    async function startLoginFlow() {
      try {
        const res = await fetch('https://sglcn-x20-api.glitch.me/login');
        const data = await res.json();
        window.open(data.payloadURL, "_blank");

        const interval = setInterval(async () => {
          const check = await fetch(`https://sglcn-x20-api.glitch.me/check-login?uuid=${data.payloadUUID}`);
          const loginStatus = await check.json();
          if (loginStatus.loggedIn) {
            clearInterval(interval);
            localStorage.setItem('xumm_wallet_address', loginStatus.account);
            updateWalletStatus();
          }
        }, 3000);
      } catch (err) {
        alert('Login failed: ' + err.message);
      }
    }

    document.getElementById('logout-btn').onclick = () => {
      localStorage.removeItem('xumm_wallet_address');
      updateWalletStatus();
    };

    function formatPrice(price) {
      return !price || isNaN(price) ? '' : Number(price).toFixed(6);
    }

    function formatAmount(amount) {
      return !amount || isNaN(amount) ? '' : Number(amount).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    async function updateCurrentPrice() {
      try {
        const res = await fetch('https://sglcn-x20-api.glitch.me/api/orderbook');
        const data = await res.json();

        const midPrice = data.midPrice;
        const bids = Array.isArray(data.bids) ? data.bids.slice(0, 100) : [];
        const asks = Array.isArray(data.asks) ? data.asks.slice(0, 100) : [];

        document.getElementById('price-value').textContent = isNaN(midPrice) ? 'N/A' : parseFloat(midPrice).toFixed(6);

        asks.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
        asks.reverse();  // reverse so lowest ask is at bottom

        bids.sort((a, b) => parseFloat(b.price) - parseFloat(a.price));
        bids.reverse();  // reverse so highest bid is at bottom


        const tbody = document.getElementById('orderbook-body');
        tbody.innerHTML = '';

        const maxRows = Math.max(asks.length, bids.length);
        for (let i = 0; i < maxRows; i++) {
          const ask = asks[i];
          const bid = bids[i];
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="green">${ask ? formatPrice(ask.price) : ''}</td>
            <td class="green">${ask ? formatAmount(ask.amount) : ''}</td>
            <td class="red">${bid ? formatPrice(bid.price) : ''}</td>
            <td class="red">${bid ? formatAmount(bid.amount) : ''}</td>
          `;
          tbody.appendChild(row);
        }

        if (tbody.children.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4">No orderbook data available</td></tr>`;
        }
      } catch (err) {
        console.error('Orderbook error:', err);
        document.getElementById('price-value').textContent = 'Error';
        document.getElementById('orderbook-body').innerHTML = `<tr><td colspan="4">Failed to load orderbook</td></tr>`;
      }
    }

    async function placeBuyOrder() {
      const wallet = localStorage.getItem('xumm_wallet_address');
      if (!wallet) return alert("Please log in first.");
      const price = parseFloat(document.getElementById('buy-price').value);
      const amount = parseInt(document.getElementById('buy-amount').value);
      if (!price || !amount) return alert("Enter valid price and amount.");
      const res = await fetch('https://sglcn-x20-api.glitch.me/api/buy-offer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ wallet, price, amount })
      });
      const data = await res.json();
      if (data.payloadURL) window.open(data.payloadURL, '_blank');
      else alert("Error placing buy offer.");
    }
    
    let chart;

  async function loadChartData() {
    const timeframe = document.getElementById("timeframe").value;

    try {
      const [res1, res2] = await Promise.all([
        fetch('https://sglcn-x20-api.glitch.me/api/sglcn-xrp'),
        fetch('https://sglcn-x20-api.glitch.me/api/orderbook')
      ]);
      const sglcnPrices = await res1.json(); // Assume this is [{timestamp, price}]
      const orderData = await res2.json(); // Includes lastTradedPrice

      // Simulate historical lastTradedPrice data from this moment
      const now = new Date();
      let dataPoints = [];

      for (let i = 0; i < 100; i++) {
        const minutesAgo = 100 - i;
        const t = new Date(now.getTime() - minutesAgo * 60000);
        const fluctuation = (Math.random() - 0.5) * 0.01;
        const price = parseFloat(orderData.lastTradedPrice || 0.0) * (1 + fluctuation);
        dataPoints.push({ t, y: price });
      }

      // Filter by timeframe
      let filtered;
      if (timeframe === "1D") {
        filtered = dataPoints.slice(-24);
      } else if (timeframe === "1W") {
        filtered = dataPoints.slice(-24 * 7);
      } else if (timeframe === "1M") {
        filtered = dataPoints.slice(-24 * 30);
      } else {
        filtered = dataPoints;
      }

      const labels = filtered.map(pt => pt.t.toLocaleTimeString());
      const values = filtered.map(pt => pt.y.toFixed(6));

      if (chart) chart.destroy();
      const ctx = document.getElementById("priceChart").getContext("2d");
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Last Traded Price (SGLCN/XRP)',
            data: values,
            borderColor: 'rgba(0, 192, 255, 1)',
            backgroundColor: 'rgba(0, 192, 255, 0.2)',
            tension: 0.2
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Price in XRP' }
            },
            x: {
              title: { display: true, text: 'Time' }
            }
          }
        }
      });
    } catch (err) {
      console.error('Chart fetch error:', err);
    }
  }

  window.onload = function () {
    updateWalletStatus();
    updateCurrentPrice();
    loadChartData();
  };


    window.addEventListener('DOMContentLoaded', () => {
      updateWalletStatus();
      updateCurrentPrice();
      setInterval(updateCurrentPrice, 60000);
    });
    
    // Optional: add auto-refresh toggle
let autoRefresh = true;

function toggleAutoRefresh() {
  autoRefresh = !autoRefresh;
  document.getElementById('refresh-toggle').textContent = autoRefresh ? 'Pause Auto-Refresh' : 'Resume Auto-Refresh';
}

setInterval(() => {
  if (autoRefresh) updateCurrentPrice();
}, 60000);

    
  </script>
</body>
</html>
