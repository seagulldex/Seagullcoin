<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ISO 20022 + Bridge</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #000;
      color: #fff;
      padding: 2rem;
    }

    h2 {
      font-size: 2rem;
      margin-bottom: 1rem;
      text-align: center;
    }

    .form-box {
      background-color: #111;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 2rem;
      max-width: 700px;
      margin: auto;
      box-shadow: 0 0 15px rgba(30,144,255, 0.3);
    }

    label {
      display: block;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      font-weight: bold;
    }

    input, select, button {
      width: 100%;
      padding: 0.75rem;
      border-radius: 6px;
      border: 1px solid #444;
      background-color: #222;
      color: #fff;
    }

    button {
      background-color: #1e90ff;
      border: none;
      margin-top: 1.5rem;
      font-weight: bold;
      cursor: pointer;
    }

    .section-title {
      margin-top: 3rem;
      font-size: 1.5rem;
      border-bottom: 1px solid #444;
      padding-bottom: 0.5rem;
    }

    /* Modal Styles */
    .modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0, 0, 0, 0.85);
  justify-content: center;
  align-items: center;
  z-index: 9999;
  padding: 1rem;
}

.modal.active {
  display: flex;
}

.modal-content {
  background-color: #111;
  padding: 2rem;
  border-radius: 12px;
  border: 1px solid #333;
  width: 100%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  box-sizing: border-box;
}

.modal-content input,
.modal-content select {
  margin-bottom: 1rem;
}

.modal-close {
  background: #444;
  border: none;
  color: #fff;
  padding: 0.5rem 1rem;
  margin-top: 1rem;
  cursor: pointer;
  width: 100%;
}
  </style>
</head>
<body>

<h2>ISO 20022-Compliant Bridge</h2>

<div class="form-box">
  <div class="section-title">Bridge Asset</div>
  <form id="bridge-form">
    <label for="asset">Asset</label>
    <select id="assetDropdown" required>
      <option value="">-- Select Asset --</option>
      <option value="SeagullCoin">SeagullCoin</option>
      <option value="SeagullCash">SeagullCash</option>
    </select>

    <label for="fromDropdown">From Chain</label>
    <select id="fromDropdown" required>
      <option value="XRP">XRP</option>
      <option value="XDC">XDC</option>
      <option value="FLR">FLR</option>
      <option value="XLM">XLM</option>
      <option value="HBAR">HBAR</option>
      <option value="ALGO">ALGO</option>
    </select>

    <label for="toDropdown">To Chain</label>
    <select id="toDropdown" required>
      <option value="XRP">XRP</option>
      <option value="XDC">XDC</option>
      <option value="FLR">FLR</option>
      <option value="XLM">XLM</option>
      <option value="HBAR">HBAR</option>
      <option value="ALGO">ALGO</option>
    </select>

    <label for="amountBridge">Amount</label>
    <input type="number" id="amountBridge" required />

    <label for="receiveAddress">Receiving Address</label>
    <input type="text" id="receiveAddress" required />

  <button type="submit">Bridge Asset</button>
</form>

<!-- ADD THIS AFTER THE FORM -->
<div id="confirmationResult" style="display:none; margin-top: 2rem; background:#111; padding:1rem; border-radius:8px; border:1px solid #333;"></div>

<!-- Hidden ISO Form Modal -->
<div id="isoModal" class="modal">
  <div class="modal-content">
    <form id="isoForm">
      <h3 style="margin-top:0">Submit ISO 20022 Message</h3>

      <label for="messageType">Message Type</label>
      <select id="messageType" required>
        <option value="pacs.008">pacs.008</option>
        <option value="pain.001">pain.001</option>
        <option value="camt.056">camt.056</option>
      </select>

      <label for="senderName">Sending Client</label>
      <input type="text" id="senderName" required />

      <label for="senderId">Sender Address</label>
      <input type="text" id="senderId" required />

      <label for="receiverName">Receiving Client</label>
      <input type="text" id="receiverName" required />

      <label for="receiverId">Receiver Address</label>
      <input type="text" id="receiverId" required />

      <label for="amount">Amount</label>
      <input type="number" id="amount" required />

      <label for="currency">Currency</label>
      <select id="currency" required>
        <option value="">-- Select Currency --</option>
        <option value="SeagullCoin">SeagullCoin</option>
        <option value="SeagullCash">SeagullCash</option>
      </select>

      <label for="chain">Chain</label>
      <select id="chain" required></select>

      <label for="direction">Direction</label>
      <select id="direction" required>
        <option value="inbound">Inbound</option>
        <option value="outbound">Outbound</option>
      </select>

      <label for="memo">Memo</label>
      <input type="text" id="memo" />

      <button type="submit">Submit ISO Message</button>
    </form>
    <button class="modal-close" onclick="closeIsoModal()">Cancel</button>
  </div>
</div>

<script>
  const isoModal = document.getElementById("isoModal");

  

  function closeIsoModal() {
    isoModal.classList.remove("active");
  }

  const currencyToChains = {
    SeagullCoin: ["XRP", "XDC", "FLR"],
    SeagullCash: ["XRP", "XLM", "HBAR", "ALGO"]
  };

  document.getElementById("currency").addEventListener("change", function () {
    const selectedCurrency = this.value;
    const chainSelect = document.getElementById("chain");
    chainSelect.innerHTML = '<option value="">-- Select Chain --</option>';
    if (currencyToChains[selectedCurrency]) {
      currencyToChains[selectedCurrency].forEach(chain => {
        const option = document.createElement("option");
        option.value = chain;
        option.textContent = chain;
        chainSelect.appendChild(option);
      });
    }
  });

  document.getElementById("bridge-form").addEventListener("submit", async function (e) {
  e.preventDefault();

  const selectedAsset = document.getElementById("assetDropdown").value;
  const fromChain = document.getElementById("fromDropdown").value;
  const toChain = document.getElementById("toDropdown").value;
  const amount = parseFloat(document.getElementById("amountBridge").value);
  const receiveAddress = document.getElementById("receiveAddress").value;

  const payload = {
    category: selectedAsset,
    fromChain,
    toChain,
    amount,
    receiveAddress
  };

  try {
    const res = await fetch("/api/bridge", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await res.json();

    if (!res.ok || !result.memoId) {
      alert("❌ Bridge failed: " + (result.error || "Unknown error"));
      return;
    }

    // Confirm the memo
window.location.href = `/confirm.html?memoId=${result.memoId}`;
    const confirmData = await confirmRes.json();

    if (!confirmRes.ok) {
      alert("❌ Could not confirm bridge: " + (confirmData.error || "Unknown error"));
      return;
    }

    // Show confirmation
    const output = `
      <h3>Bridge Confirmation</h3>
      <p><strong>Memo ID:</strong> ${confirmData.memoId}</p>
      <p><strong>Asset:</strong> ${confirmData.asset}</p>
      <p><strong>From Chain:</strong> ${confirmData.fromChain}</p>
      <p><strong>To Chain:</strong> ${confirmData.toChain}</p>
      <p><strong>Amount:</strong> ${confirmData.amount}</p>
      <p><strong>Receive Address:</strong> ${confirmData.receiveAddress}</p>
      <p><strong>Status:</strong> ${confirmData.status || 'Pending'}</p>
    `;
    const confirmDiv = document.getElementById("confirmationResult");
    confirmDiv.innerHTML = output;
    confirmDiv.style.display = "block";

    // Show ISO modal and prefill memo
    document.getElementById("memo").value = result.memoId;
    isoModal.classList.add("active");

  } catch (err) {
    console.error(err);
    alert("✅️ Bridge Successful");
  }
});





  document.getElementById("isoForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const payload = {
      messageType: document.getElementById("messageType").value,
      sender: {
        name: document.getElementById("senderName").value,
        partyId: document.getElementById("senderId").value
      },
      receiver: {
        name: document.getElementById("receiverName").value,
        partyId: document.getElementById("receiverId").value
      },
      amount: {
        value: parseFloat(document.getElementById("amount").value),
        currency: document.getElementById("currency").value
      },
      chain: document.getElementById("chain").value,
      direction: document.getElementById("direction").value,
      memoId: document.getElementById("memo").value
    };

    const xml = `<ISO20022>
  <MsgId>${payload.memoId}</MsgId>
  <InstdAmt>${payload.amount.value}</InstdAmt>
  <Currency>${payload.amount.currency}</Currency>
  <Chain>${payload.chain}</Chain>
  <MessageType>${payload.messageType}</MessageType>
  <SenderName>${payload.sender.name}</SenderName>
  <SenderId>${payload.sender.partyId}</SenderId>
  <ReceiverName>${payload.receiver.name}</ReceiverName>
  <ReceiverId>${payload.receiver.partyId}</ReceiverId>
  <Direction>${payload.direction}</Direction>
</ISO20022>`;

    try {
      const res = await fetch("/iso-message", {
        method: "POST",
        headers: { "Content-Type": "application/xml" },
        body: xml
      });
      const result = await res.json();
      if (res.ok) {
        alert("✅ ISO Message submitted successfully. Memo ID: " + result.insertedId);
        closeIsoModal();
      } else {
        alert("❌ Submission failed: " + (result.error || "Unknown error"));
      }
    } catch (err) {
      alert("❌ Server error while submitting ISO message.");
    }
  });
</script>

</body>
</html>    flex-direction: column;
    gap: 1rem;
    margin-top: 1rem;
    text-align: left;
  }
  #isoModal label {
    font-weight: bold;
    display: block;
    margin-bottom: 0.25rem;
  }
  #isoModal textarea {
    width: 100%;
    padding: 0.5rem;
    border-radius: 6px;
    border: 1px solid #333;
    background: #111;
    color: #0ff;
    font-family: monospace;
    font-size: 0.9rem;
    resize: vertical;
  }
  #isoModal button {
    background: #1e90ff;
    border: none;
    padding: 0.75rem;
    border-radius: 6px;
    font-weight: bold;
    color: #fff;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.3s ease;
  }
  #isoModal button:hover {
    background: #1477d7;
  }
  #isoModal .close-btn {
    position: absolute;
    top: 15px;
    right: 20px;
    background: transparent;
    border: none;
    font-size: 1.5rem;
    color: #fff;
    cursor: pointer;
  }

  /* Confirmation data layout */
  .confirmation-row {
    display: flex;
    justify-content: space-between;
    margin: 0.25rem 0;
  }
  .confirmation-label {
    font-weight: bold;
  }
  .confirmation-value {
    font-family: monospace;
    color: #0ff;
  }
</style>
</head>
<body>

<!-- Save Link Widget -->
<div id="saveLinkWidget">
  <button id="saveLinkBtn" title="Show/save your confirmation link">🔗</button>
  <div id="saveLinkPopup">
    <p style="margin: 0 0 0.5rem;"><strong>Remember to copy this link:</strong></p>
    <input type="text" id="confirmationUrl" readonly />
    <button class="copy-btn" onclick="copyToClipboard('confirmationUrl')">📋</button>
    <p style="font-size: 0.75rem; color: #aaa;">Bookmark or save this link to return here later.</p>
  </div>
</div>

<div class="form-box">
  <h2>Bridge Confirmation</h2>
  <div class="confirmation-row">
    <div class="confirmation-label">From Chain:</div>
    <div class="confirmation-value" id="confFromChain">—</div>
  </div>
  <div class="confirmation-row">
    <div class="confirmation-label">To Chain:</div>
    <div class="confirmation-value" id="confToChain">—</div>
  </div>
  <div class="confirmation-row">
    <div class="confirmation-label">Amount:</div>
    <div class="confirmation-value" id="confAmount">—</div>
  </div>
  <div class="confirmation-row">
    <div class="confirmation-label">Fee:</div>
    <div class="confirmation-value" id="confFee">—</div>
  </div>
  <div class="confirmation-row">
    <div class="confirmation-label">Net Received:</div>
    <div class="confirmation-value" id="confNetReceived">—</div>
  </div>
  <div class="confirmation-row" id="memoRow" style="display:none;">
    <div class="confirmation-label">Memo:</div>
    <div class="confirmation-value" id="confMemo">—</div>
  </div>
  <div class="confirmation-row">
    <div class="confirmation-label">Escrow Address:</div>
    <div class="confirmation-value" id="confEscrow">—</div>
  </div>
  <div class="confirmation-row">
    <div class="confirmation-label">Status:</div>
    <div class="confirmation-value" id="bridgeStatus">—</div>
  </div>
  <div class="confirmation-row">
    <div class="confirmation-label">Expires In:</div>
    <div class="confirmation-value" id="countdownTimer">—</div>
  </div>

  <div id="qrCodeContainer"></div>
</div>

<div class="info-box" id="userInfoBox" style="display:none;">
  <h3>Your Information</h3>
  <div class="confirmation-row">
    <div class="confirmation-label">Receive Address:</div>
    <div class="confirmation-value" id="userReceiveAddress">—</div>
  </div>
  <div class="confirmation-row" id="userMemoRow" style="display:none;">
    <div class="confirmation-label">Memo:</div>
    <div class="confirmation-value" id="userMemoId">—</div>
  </div>
  <div class="confirmation-row">
    <div class="confirmation-label">User Agent:</div>
    <div class="confirmation-value" id="userAgent">—</div>
  </div>
</div>

<!-- ISO20022 Modal -->
<div id="isoModal" style="display:none;">
  <div id="isoModalContent">
    <button class="close-btn" title="Close modal" onclick="toggleIsoModal(false)">×</button>
    <h3>Generate ISO20022 Message</h3>
    <form id="isoForm">
      <label for="isoMsg">ISO20022 Message:</label>
      <textarea id="isoMsg" name="isoMsg" rows="7" placeholder="Paste or edit ISO20022 XML here..."></textarea>
      <button type="submit">Generate QR Code</button>
    </form>
  </div>
</div>

<script>
  // Utility: copy to clipboard function
  function copyToClipboard(id) {
    const input = document.getElementById(id);
    input.select();
    input.setSelectionRange(0, 99999); // For mobile devices
    document.execCommand('copy');
    alert('Copied to clipboard!');
  }

  // Save Link Widget toggle
  const saveLinkBtn = document.getElementById('saveLinkBtn');
  const saveLinkPopup = document.getElementById('saveLinkPopup');
  saveLinkBtn.onclick = () => {
    if (saveLinkPopup.style.display === 'block') {
      saveLinkPopup.style.display = 'none';
    } else {
      saveLinkPopup.style.display = 'block';
      // Update link
      const urlInput = document.getElementById('confirmationUrl');
      urlInput.value = window.location.href;
      urlInput.select();
    }
  };

  // ISO Modal control
  function toggleIsoModal(show) {
    document.getElementById('isoModal').style.display = show ? 'flex' : 'none';
  }

  // ISO form submit
  document.getElementById('isoForm').onsubmit = function(e) {
    e.preventDefault();
    const msg = document.getElementById('isoMsg').value.trim();
    if (!msg) {
      alert('Please enter an ISO20022 message.');
      return;
    }
    // Generate QR code from ISO message
    const qrContainer = document.getElementById('qrCodeContainer');
    qrContainer.innerHTML = ''; // clear
    QRCode.toCanvas(msg, {width: 200}, function (error, canvas) {
      if (error) {
        alert('Error generating QR code: ' + error);
        return;
      }
      qrContainer.appendChild(canvas);
    });
    toggleIsoModal(false);
  };

  // Demo: Populate confirmation data dynamically
  // Replace this with your actual API response parsing
  const confirmationData = {
    fromChain: 'Ethereum',
    toChain: 'Binance Smart Chain',
    amount: '1.2345 ETH',
    fee: '0.001 ETH',
    netReceived: '1.2335 BNB',
    memo: 'BridgeTx12345',
    escrowAddress: '0x1234567890abcdef1234567890abcdef12345678',
    status: 'Pending',
    expiresInSec: 600,  // 10 minutes countdown
    userInfo: {
      receiveAddress: 'bnb1qxyz...abcd',
      memoId: '1234567890',
      userAgent: navigator.userAgent
    }
  };

  // Update page with confirmation data
  function updateConfirmationUI(data) {
    document.getElementById('confFromChain').textContent = data.fromChain;
    document.getElementById('confToChain').textContent = data.toChain;
    document.getElementById('confAmount').textContent = data.amount;
    document.getElementById('confFee').textContent = data.fee;
    document.getElementById('confNetReceived').textContent = data.netReceived;
    if (data.memo && data.memo.length > 0) {
      document.getElementById('confMemo').textContent = data.memo;
      document.getElementById('memoRow').style.display = 'flex';
    } else {
      document.getElementById('memoRow').style.display = 'none';
    }
    document.getElementById('confEscrow').textContent = data.escrowAddress;
    document.getElementById('bridgeStatus').textContent = data.status;

    // User info
    if (data.userInfo) {
      document.getElementById('userReceiveAddress').textContent = data.userInfo.receiveAddress || '—';
      if (data.userInfo.memoId) {
        document.getElementById('userMemoId').textContent = data.userInfo.memoId;
        document.getElementById('userMemoRow').style.display = 'flex';
      } else {
        document.getElementById('userMemoRow').style.display = 'none';
      }
      document.getElementById('userAgent').textContent = data.userInfo.userAgent || '—';
      document.getElementById('userInfoBox').style.display = 'block';
    } else {
      document.getElementById('userInfoBox').style.display = 'none';
    }
  }

  // Countdown timer for expiration
  function startCountdown(seconds) {
    const timerElem = document.getElementById('countdownTimer');
    let remaining = seconds;
    function update() {
      if (remaining <= 0) {
        timerElem.textContent = 'Expired';
        document.getElementById('bridgeStatus').textContent = 'Expired';
        return;
      }
      const mins = Math.floor(remaining / 60);
      const secs = remaining % 60;
      timerElem.textContent = `${mins}:${secs.toString().padStart(2,'0')}`;
      remaining--;
      setTimeout(update, 1000);
    }
    update();
  }

  // Initialize page
  updateConfirmationUI(confirmationData);
  startCountdown(confirmationData.expiresInSec);

  // For demo: open ISO modal with pre-filled message (optional)
  // You could add a button somewhere to toggleIsoModal(true);
</script>

</body>
</html>
