<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://unpkg.com/qrcode/build/qrcode.min.js"></script>
  <title>Bridge Confirmation (ISO20022)</title>
  <style>
    body {
      background: #000 url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1350&q=80') center/cover fixed;
      color: #fff;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      padding: 2rem;
    }
    .form-box {
      background: rgba(17,17,17,0.94);
      padding: 1.5rem;
      max-width: 880px;
      margin: 0 auto;
      border-radius: 10px;
      box-shadow: 0 6px 30px rgba(30,144,255,0.12);
    }
    .deposit-row {
  display: flex;
  gap: 12px;
  align-items: center;
  width: 100%;
  flex-wrap: nowrap; /* prevent wrapping */
}

.deposit-value {
  flex: 1 1 auto;
  min-width: 0;
  word-break: break-word;
  overflow-wrap: anywhere;
  max-width: calc(100% - 60px); /* leave space for copy button */
}

.deposit-row .copy-btn {
  flex: 0 0 48px; /* fixed width for button */
  white-space: nowrap;
}
.deposit-row .value {
  word-wrap: break-word;
  overflow-wrap: anywhere;
  white-space: normal; /* ensure it wraps */
}


/* For the status row (countdown on right) */
.row.status-row {
  display: flex;
  align-items: center;
  gap: 12px;
}

.row.status-row .label {
  flex: 0 0 120px;
}

#bridgeStatus {
  flex: 0 0 auto;
}
#qrCodeContainer {
  display: none;
}
#countdownTimer {
  flex: 0 0 auto;
  margin-left: auto;
  font-weight: 600;
}
   h1 { color: #1e90ff; margin:0 0 12px; font-size:1.4rem; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .label { min-width:120px; color:#cfeeff; font-weight:600; }
    .mono { font-family: ui-monospace, SFMono-Regular, "Roboto Mono", Menlo, monospace; color:#00e5ff; }
    .copy-btn { background:#1e90ff; color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
    .copy-btn:active { transform:translateY(1px); }
    #qrCodeContainer { margin-top:12px; text-align:center; }
    .small { font-size:0.9rem; color:#bbb; }
    pre { background:#0f0f12; padding:10px; border-radius:8px; overflow:auto; max-height:260px; color:#dbefff; }
    .controls { display:flex; gap:8px; align-items:center; margin-top:10px; flex-wrap:wrap; }
    #saveLinkWidget { position: fixed; top: 18px; left: 18px; z-index: 999; }
    #saveLinkBtn { background: #1e90ff; color: white; border: none; border-radius: 50%; width: 36px; height: 36px; cursor:pointer; box-shadow: 0 0 10px rgba(30,144,255,0.6); }
    #saveLinkPopup { background: rgba(0,0,0,0.95); color: #fff; border-radius:8px; padding:10px; width:320px; margin-top:8px; display:none; box-shadow:0 6px 20px rgba(0,0,0,0.6); }
    #saveLinkPopup input { width:100%; padding:8px; border-radius:6px; border:1px solid #333; background:#0b0b0b; color:#0ff; }
    .status-badge { padding:6px 10px; border-radius:8px; font-weight:600; display:inline-block; }
    .status-pending { background: rgba(255,255,255,0.04); color:#ffd; border:1px solid rgba(255,255,255,0.04); }
    .status-confirmed { background: rgba(0,200,120,0.12); color:#8ff; border:1px solid rgba(0,200,120,0.08); }
    .status-bridged { background: rgba(30,144,255,0.12); color:#cfe; border:1px solid rgba(30,144,255,0.08); }
    .status-expired { background: rgba(255,60,60,0.12); color:#f88; border:1px solid rgba(255,60,60,0.08); }

    /* deposit-specific layout so long addresses wrap and the copy button stays visible */
    .deposit-row { display:flex; gap:12px; align-items:center; width:100%; }
    .deposit-value { flex: 1 1 auto; min-width: 0; word-break: break-word; overflow-wrap: anywhere; }
    .memo-value { flex: 1 1 auto; min-width: 0; word-break: break-word; overflow-wrap: anywhere; }

    @media (max-width:640px){ .label { min-width: 100px } }
  </style>
</head>
<body>

<div id="saveLinkWidget">
  <button id="saveLinkBtn" title="Click to show/save your confirmation link">üîó</button>
  <div id="saveLinkPopup" aria-hidden="true">
    <p style="margin:0 0 8px;"><strong>Remember to copy this link:</strong></p>
    <input id="confirmationUrl" readonly />
    <div style="margin-top:8px;"><button class="copy-btn" onclick="copyInputValue('confirmationUrl')">üìã Copy link</button></div>
    <p class="small" style="margin-top:8px;">Bookmark or save this link to return here later.</p>
  </div>
</div>

<div class="form-box" role="main" aria-labelledby="title">
  <h1 id="title">Bridge Confirmation (ISO20022)</h1>

  <div class="row"><div class="label">From Chain</div>
    <img id="confFromChainLogo" alt="" style="height:22px;vertical-align:middle;margin-right:8px"/>
    <div id="confFromChain" class="mono">‚Äî</div>
  </div>

  <div class="row"><div class="label">To Chain</div>
    <img id="confToChainLogo" alt="" style="height:22px;vertical-align:middle;margin-right:8px"/>
    <div id="confToChain" class="mono">‚Äî</div>
  </div>

  <div class="row"><div class="label">Send</div>
    <div id="confAmount" class="mono">‚Äî</div>
  </div>

  <div class="row"><div class="label">Sender</div>
    <div id="confSender" class="mono">‚Äî</div>
  </div>

  <div class="row"><div class="label">Receiver</div>
    <div id="confReceiver" class="mono">‚Äî</div>
  </div>

  <div class="row deposit-row">
    <div class="label">Deposit Address</div>
    <div id="confEscrow" class="mono deposit-value">‚Äî</div>
    <button class="copy-btn" onclick="copyTextFromEl('confEscrow')">üìã Copy</button>
  </div>

  <div class="row" id="memoRow">
    <div class="label">Memo / Tag</div>
    <div id="confMemo" class="mono memo-value">‚Äî</div>
    <button class="copy-btn" onclick="copyTextFromEl('confMemo')">üìã Copy</button>
  </div>

  <div class="row">
    <div class="label">Status</div>
    <div id="bridgeStatus" class="status-badge status-pending">Loading...</div>
    <div style="margin-left:auto" class="small">Expires in: <span id="countdownTimer">‚Äî</span></div>
  </div>

  <div id="qrCodeContainer" style="margin-top:12px;text-align:center"></div>

  <div class="controls">
    <button class="copy-btn" id="toggleIsoBtn">View ISO XML</button>
  </div>

  <div style="margin-top:12px;display:none" id="isoSection">
    <h3 style="margin:0 0 8px;">ISO20022 Raw XML</h3>
    <pre id="rawXml" aria-live="polite">‚Äî</pre>
  </div>
</div>

<script>
/* ---------- helpers & config ---------- */
const escrowAddresses = {
  XRP: "rU3y41mnPFxRhVLxdsCRDGbE2LAkVPEbLV",
  XLM: "GD2VMYH62JD2ZGTMMWFCU5YNMASC5NWZ5FM5WN2GWLYAACYXP6BKG44I",
  HBAR: "0.0.2928384",
  ALGO: "YFZD6UWU5KXQINAN4CV6UCMIMRFSTKXNFQWV7WUSYQIWASCH2AX4LT4RMM",
  FLR: "0x3B51F488f729e5Cfa566990Fd7f069F364b6984D",
  XDC: "xdc870f64E73e7D2dc5022b4b74e58C323b3148A984"
};
const chainsUsingMemo = ["XRP","XLM","HBAR"];

function getUrlParam(name){ return new URLSearchParams(window.location.search).get(name); }
function getMemoIdFromUrl(){ return getUrlParam('memoId'); }

function copyInputValue(id) {
  const el = document.getElementById(id);
  if (!el) return alert('No input found');
  navigator.clipboard.writeText(el.value).then(()=>alert('Copied link')).catch(()=>alert('Copy failed'));
}
function copyTextFromEl(id){
  const el = document.getElementById(id);
  const text = el ? el.textContent.trim() : '';
  if (!text) return alert('Nothing to copy');
  navigator.clipboard.writeText(text).then(()=>alert('Copied')).catch(()=>alert('Copy failed'));
}
function setConfirmationLinkInput(){
  const input = document.getElementById('confirmationUrl');
  if (!input) return;
  input.value = window.location.href;
}

function getLogo(key) {
  const map = {
    SeagullCoin: 'https://xpcdn.xpmarket.com/storage/logo/SeagullCoin_rnqiA8vuNriU9pqD1ZDGFH8ajQBL25Wkno.webp',
    XRP: 'https://altcoinsbox.com/wp-content/uploads/2023/01/xrp-logo-1140x1140.webp',
    XLM: 'https://files.swissborg.com/product/wealth-app/assets/ic_crypto_xlm.png',
    HBAR: 'https://altcoinsbox.com/wp-content/uploads/2023/03/hedera-logo-1140x1140.webp',
    FLR: 'https://s2.coinmarketcap.com/static/img/coins/64x64/7950.png',
    XDC: 'https://cdn.coincircle.com/icons/fallback/xdc-network.png',
    ALGO: 'https://cdn.freelogovectors.net/wp-content/uploads/2021/10/algorand-logo-freelogovectors.net_.png'
  };
  return map[key] || '';
}
function formatNumber(n){
  if (n===null||n===undefined||isNaN(Number(n))) return String(n);
  return Number(n).toLocaleString(undefined, {maximumFractionDigits:8});
}

/* ---------- QR generation (robust) ---------- */
function generateQRCode(containerEl, text) {
  containerEl.innerHTML = '';
  if (!text) return;
  // prefer QRCode.toCanvas if available
  try {
    if (window.QRCode && typeof window.QRCode.toCanvas === 'function') {
      const canvas = document.createElement('canvas');
      window.QRCode.toCanvas(canvas, text, { width: 180 }, (err) => {
        if (err) fallbackConstructor();
        else containerEl.appendChild(canvas);
      });
      return;
    }
  } catch(e){ console.warn('toCanvas attempt failed', e); }
  // constructor fallback
  function fallbackConstructor(){
    try {
      if (typeof window.QRCode === 'function') {
        new window.QRCode(containerEl, { text, width:180, height:180 });
        return;
      }
    } catch(e){ console.warn('constructor fallback failed', e); }
    // final fallback: show the text so user can copy
    const txt = document.createElement('div');
    txt.className = 'small';
    txt.textContent = text;
    containerEl.appendChild(txt);
  }
  fallbackConstructor();
}

/* ---------- status mapping ---------- */
function mapStatusLabel(statusStr){
  statusStr = (statusStr||'').toString().toLowerCase();
  switch(statusStr){
    case 'pending': return {text:'Pending confirmation...', cls:'status-pending'};
    case 'confirmed': return {text:'Confirmed ‚úÖ', cls:'status-confirmed'};
    case 'bridged': return {text:'Bridged üåâ', cls:'status-bridged'};
    case 'validated': return {text:'Validated ‚úÖ', cls:'status-confirmed'};
    case 'expired': return {text:'Expired ‚ùå', cls:'status-expired'};
    case 'failed': return {text:'Failed ‚ùå', cls:'status-expired'};
    default: return {text: statusStr || 'Pending confirmation...', cls:'status-pending'};
  }
}

/* ---------- countdown from createdAt (default 24h, override via ?expiresHours=6) ---------- */
let countdownInterval = null;
function startCountdownFromCreated(createdAtStr, expiresHours) {
  if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
  let createdTs = Date.parse(createdAtStr);
  if (!createdTs || isNaN(createdTs)) createdTs = Date.now();
  const expiresMs = (Number(expiresHours) || 24) * 3600 * 1000;
  const expiryTs = createdTs + expiresMs;

  function tick(){
    const diff = expiryTs - Date.now();
    const el = document.getElementById('countdownTimer');
    if (!el) return;
    if (diff <= 0) {
      el.textContent = 'Expired';
      setStatusExpired();
      clearInterval(countdownInterval);
      countdownInterval = null;
      return;
    }
    const hrs = Math.floor(diff / (1000*60*60));
    const mins = Math.floor((diff % (1000*60*60)) / (1000*60));
    const secs = Math.floor((diff % (1000*60)) / 1000);
    el.textContent = `${hrs}h ${mins}m ${secs}s`;
  }
  tick();
  countdownInterval = setInterval(tick, 1000);
}
function setStatusExpired(){
  const statusEl = document.getElementById('bridgeStatus');
  if (!statusEl) return;
  statusEl.textContent = 'Expired ‚ùå';
  statusEl.className = 'status-badge status-expired';
}

/* ---------- render function ---------- */
function renderData(data){
  const parsed = data.parsedJson || {};
  const fromChain = (parsed.FromChain || data.chain || '').toString();
  const toChain = (parsed.ToChain || data.toChain || '').toString();

  const amountValue = data.amount?.value ?? parsed.InstdAmt ?? data.amount;
  const amountCurrency = data.amount?.currency ?? parsed.Currency ?? '';

  const setText = (id, txt) => { const e=document.getElementById(id); if(e) e.textContent = (txt===undefined||txt===null)?'‚Äî':String(txt); };
  setText('confFromChain', fromChain || 'N/A');
  setText('confToChain', toChain || 'N/A');

  const fromLogo = getLogo(fromChain) || getLogo(amountCurrency);
  const toLogo = getLogo(toChain);
  const logoFromEl = document.getElementById('confFromChainLogo');
  const logoToEl = document.getElementById('confToChainLogo');
  if (logoFromEl) { if (fromLogo) { logoFromEl.src = fromLogo; logoFromEl.style.display='inline-block'; } else logoFromEl.style.display='none'; }
  if (logoToEl) { if (toLogo) { logoToEl.src = toLogo; logoToEl.style.display='inline-block'; } else logoToEl.style.display='none'; }

  setText('confAmount', `${formatNumber(amountValue)} ${amountCurrency || ''}`);
  setText('confSender', (data.sender?.name || parsed.SenderName || 'N/A') + ' (' + (data.sender?.partyId || parsed.SenderId || 'N/A') + ')');
  setText('confReceiver', (data.receiver?.name || parsed.ReceiverName || 'N/A') + ' (' + (data.receiver?.partyId || parsed.ReceiverId || 'N/A') + ')');

  // use server memoId (unique) but fallback to parsed reference
  const memoId = data.memoId || parsed.Memo || parsed.Reference || 'N/A';
  setText('confMemo', memoId);

  // escrow deposit address
  const escrowAddr = escrowAddresses[fromChain] || escrowAddresses[(data.chain||'').toUpperCase()] || 'N/A';
  setText('confEscrow', escrowAddr);

  // memo row visibility
  const memoRow = document.getElementById('memoRow');
  if (memoRow) memoRow.style.display = chainsUsingMemo.includes(String(fromChain).toUpperCase()) ? '' : 'none';

  // status mapping (default pending)
  const statusRaw = data.status || (data.validated ? 'validated' : 'pending');
  const statusInfo = mapStatusLabel(statusRaw);
  const statusEl = document.getElementById('bridgeStatus');
  if (statusEl) { statusEl.textContent = statusInfo.text; statusEl.className = 'status-badge ' + statusInfo.cls; }

  // QR code: include memo when applicable
  const qrContainer = document.getElementById('qrCodeContainer');
  let qrData = escrowAddr;
  if (escrowAddr && chainsUsingMemo.includes(String(fromChain).toUpperCase()) && memoId && memoId!=='N/A') {
    if (String(fromChain).toUpperCase() === 'XRP') qrData = `xrpl:${escrowAddr}?dt=${memoId}`;
    else if (String(fromChain).toUpperCase() === 'XLM') qrData = `web+stellar:pay?destination=${escrowAddr}&memo=${memoId}`;
    else if (String(fromChain).toUpperCase() === 'HBAR') qrData = `hedera:${escrowAddr}?memo=${memoId}`;
    else qrData = `${escrowAddr}?memo=${memoId}`;
  }
  generateQRCode(qrContainer, qrData);

  // raw XML display
  const rawXmlEl = document.getElementById('rawXml');
  if (rawXmlEl) rawXmlEl.textContent = data.rawXml || '‚Äî';

  // countdown ‚Äî default 24h from createdAt (override via ?expiresHours=N)
  const urlExpires = Number(getUrlParam('expiresHours'));
  const expiresHours = Number(data.expiresHours || urlExpires || 24);
  startCountdownFromCreated(data.createdAt || parsed.CreatedAt || new Date().toISOString(), expiresHours);
}

/* ---------- data fetch ---------- */
async function fetchIsoMessage(memoId){
  const res = await fetch(`/iso-message/${memoId}`);
  if (!res.ok) {
    const txt = await res.text().catch(()=>res.statusText);
    throw new Error(txt || `HTTP ${res.status}`);
  }
  return await res.json();
}

/* ---------- main / polling ---------- */
let currentMemo = null;
async function loadAndPollOnce() {
  const memoId = getMemoIdFromUrl();
  if (!memoId) {
    alert('No memoId in URL. Open this page with ?memoId=<id>');
    return;
  }
  currentMemo = memoId;
  setConfirmationLinkInput();

  async function runOnce() {
    try {
      const data = await fetchIsoMessage(memoId);
      renderData(data);
    } catch (err) {
      const statusEl = document.getElementById('bridgeStatus');
      if (statusEl) {
        statusEl.textContent = `Error loading data: ${err.message}`;
        statusEl.className = 'status-badge status-expired';
      }
      console.error('load error', err);
    }
  }

  await runOnce();

  // poll every 30s to refresh status and other fields
  setInterval(async () => {
    try {
      const updated = await fetchIsoMessage(memoId);
      renderData(updated);
    } catch (e) {
      console.warn('poll failed', e);
    }
  }, 30000);
}

/* ---------- UI toggles ---------- */
document.getElementById('saveLinkBtn').addEventListener('click', ()=>{
  const pop = document.getElementById('saveLinkPopup');
  if (!pop) return;
  const visible = pop.style.display === 'block';
  pop.style.display = visible ? 'none' : 'block';
  pop.setAttribute('aria-hidden', String(visible ? 'true':'false'));
});
document.getElementById('toggleIsoBtn').addEventListener('click', ()=>{
  const s = document.getElementById('isoSection');
  if (!s) return;
  s.style.display = (s.style.display === 'block') ? 'none' : 'block';
});

/* ---------- start ---------- */
window.addEventListener('load', loadAndPollOnce);
</script>

</body>
</html>
