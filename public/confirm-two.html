<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/qrcode/build/qrcode.min.js"></script>
  <title>Bridge Confirmation</title>
  <style>
    body { 
      background: #000 url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1350&q=80') no-repeat center center fixed; 
      background-size: cover;
      color: #fff; 
      font-family: sans-serif; 
      padding: 2rem; 
    }
    .form-box { 
      background: rgba(17,17,17,0.9); 
      padding: 2rem; 
      max-width: 600px; 
      margin: auto; 
      border-radius: 8px; 
      box-shadow: 0 0 15px rgba(30,144,255, 0.7); 
    }
    .info-box {
      background: rgba(0, 0, 0, 0.6);
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 0 10px rgba(30,144,255,0.5);
    }
    button.copy-btn {
      background: #1e90ff;
      border: none;
      padding: 0.2rem 0.5rem;
      margin-left: 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      color: #fff;
      font-size: 1rem;
      vertical-align: middle;
    }
    button.copy-btn:hover {
      background: #1c7ddb;
    }
    #saveLinkWidget {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 999;
    }
    #saveLinkBtn {
      background: #1e90ff;
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(30,144,255,0.6);
    }
    #saveLinkPopup {
      background: rgba(0, 0, 0, 0.9);
      color: white;
      border-radius: 6px;
      padding: 0.75rem;
      width: 260px;
      margin-top: 8px;
      box-shadow: 0 0 10px rgba(0,255,255,0.2);
    }
    #saveLinkPopup input {
      width: 100%;
      padding: 0.25rem;
      margin-bottom: 0.5rem;
      border-radius: 4px;
      border: 1px solid #444;
      background: #111;
      color: #00ffff;
      font-size: 0.9rem;
    }
    #saveLinkPopup.hidden {
      display: none;
    }
  </style>
</head>
<body>
  
<div id="saveLinkWidget">
  <button id="saveLinkBtn" title="Click to show/save your confirmation link">ðŸ”—</button>
  <div id="saveLinkPopup" class="hidden">
    <p style="margin: 0 0 0.5rem;"><strong>Remember to copy this link:</strong></p>
    <input type="text" id="confirmationUrl" readonly />
    <button class="copy-btn" onclick="copyToClipboard('confirmationUrl')">ðŸ“‹</button>
    <p style="font-size: 0.75rem; color: #aaa;">Bookmark or save this link to return here later.</p>
  </div>
</div>

<div class="form-box">
  <h2>Bridge Confirmation</h2>
  
  <p>
    <strong>From Chain:</strong> 
    <img id="confFromChainLogo" alt="From Chain Logo" style="height:24px; vertical-align:middle; margin-right:6px;"/>
    <span id="confFromChain"></span>
  </p>
  <p>
    <strong>To Chain:</strong> 
    <img id="confToChainLogo" alt="To Chain Logo" style="height:24px; vertical-align:middle; margin-right:6px;"/>
    <span id="confToChain"></span>
  </p>
  <p><strong>Send:</strong> <span id="confAmount"></span></p>
  <p><strong>Deposit Address:</strong> 
    <span id="confEscrow" style="word-break: break-word;"></span>
    <button class="copy-btn" onclick="copyToClipboard('confEscrow')">ðŸ“‹ Copy</button>
  </p>
  <p id="memoRow"><strong>Memo ID / Tag:</strong> 
    <span id="confMemo" style="color: #1e90ff;"></span>
    <button class="copy-btn" onclick="copyToClipboard('confMemo')">ðŸ“‹ Copy</button>
  </p>
  <p><strong>Status:</strong> <span id="bridgeStatus">Fetching...</span></p>
  <p><strong>Expires in:</strong> <span id="countdownTimer">â€”</span></p>
</div>

<div class="info-box" id="userInfoBox" style="display:none;">
  <h3>Your Information</h3>
  <p><strong>Bridge Fee:</strong> <span id="confFee" style="color: #ff4d4d;"></span></p>
  <p><strong>Net Received:</strong> <span id="confNetReceived" style="color: #00ffcc;"></span></p>
  <p><strong>Receive Address:</strong> <span id="userReceiveAddress" style="word-break: break-word;"></span></p>
  <p id="userMemoRow"><strong>Memo ID / Tag:</strong> <span id="userMemoId" style="color: #1e90ff;"></span></p>
</div>

<div id="qrCodeContainer" style="margin-top: 10px;"></div>

<script>
  const escrowAddresses = {
    XRP: "rU3y41mnPFxRhVLxdsCRDGbE2LAkVPEbLV",
    XLM: "GD2VMYH62JD2ZGTMMWFCU5YNMASC5NWZ5FM5WN2GWLYAACYXP6BKG44I",
    HBAR: "0.0.2928384",
    ALGO: "YFZD6UWU5KXQINAN4CV6UCMIMRFSTKXNFQWV7WUSYQIWASCH2AX4LT4RMM",
    FLR: "0x3B51F488f729e5Cfa566990Fd7f069F364b6984D",
    XDC: "xdc870f64E73e7D2dc5022b4b74e58C323b3148A984"
  };

  const chainsUsingMemo = ["XRP", "XLM", "HBAR"];

  function copyToClipboard(id) {
    const text = document.getElementById(id).textContent;
    navigator.clipboard.writeText(text).then(() => {
      alert('Copied to clipboard!');
    }).catch(() => {
      alert('Failed to copy!');
    });
  }

  function getMemoId() {
    return new URL(window.location.href).searchParams.get("memoId");
  }

  function generateQRCode(address, elementId, fromChain, memoId) {
    const container = document.getElementById(elementId);
    container.innerHTML = ""; // Clear previous QR

    let uri;

    switch (fromChain) {
      case "XRP":
        uri = `xrp:${address}?dt=${memoId}`;
        break;
      case "XLM":
        uri = `stellar:${address}?memo=${memoId}`;
        break;
      case "HBAR":
        uri = `hedera:${address}?memo=${memoId}`;
        break;
      case "ALGO":
        uri = `algo:${address}`;
        break;
      case "FLR":
        uri = `flare:${address}`;
        break;
      case "XDC":
        uri = `xdc:${address}`;
        break;
      default:
        uri = address; // fallback
    }

    new QRCode(container, {
      text: uri,
      width: 128,
      height: 128,
    });
  }

  function getLogo(chainName) {
    const logos = {
      SeagullCoin: 'https://xpcdn.xpmarket.com/storage/logo/SeagullCoin_rnqiA8vuNriU9pqD1ZDGFH8ajQBL25Wkno.webp',
      SeagullCash: 'https://d1qg3dzzcm13k7.cloudfront.net/logo/26b2c3b6-02d8-4231-8dfd-09a1c7e4bc7f.svg',
      XRP: 'https://cryptologos.cc/logos/xrp-xrp-logo.svg?v=023',
      XLM: 'https://cryptologos.cc/logos/stellar-xlm-logo.svg?v=023',
      HBAR: 'https://cryptologos.cc/logos/hedera-hbar-logo.svg?v=023',
      ALGO: 'https://cryptologos.cc/logos/algorand-algo-logo.svg?v=023',
      FLR: 'https://cryptologos.cc/logos/flr-flare-logo.svg?v=023',
      XDC: 'https://cryptologos.cc/logos/xdc-network-xdc-logo.svg?v=023',
    };
    return logos[chainName] || '';
  }

  function fetchBridgeStatus(memoId) {
    // Mock fetch for example
    // Replace with your actual API endpoint
    // Returning a Promise that resolves with a status object

    // Simulate network delay
    return new Promise(resolve => {
      setTimeout(() => {
        // Example status, random success for demo
        const statuses = ["pending", "processing", "completed", "failed"];
        const status = statuses[Math.floor(Math.random() * statuses.length)];
        resolve({
          status,
          expiresAt: Date.now() + 15 * 60 * 1000 // expires in 15 min
        });
      }, 800);
    });
  }

  function formatNumber(num) {
    return Number(num).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 8});
  }

  function updateCountdown(expiryTimestamp) {
    const countdownEl = document.getElementById('countdownTimer');
    function update() {
      const now = Date.now();
      const diff = expiryTimestamp - now;
      if(diff <= 0){
        countdownEl.textContent = "Expired";
        clearInterval(interval);
      } else {
        const mins = Math.floor(diff / 60000);
        const secs = Math.floor((diff % 60000) / 1000);
        countdownEl.textContent = `${mins}m ${secs}s`;
      }
    }
    update();
    const interval = setInterval(update, 1000);
  }

  function displayBridgeInfo(data, memoId) {
    document.getElementById("confFromChain").textContent = data.fromChain;
    document.getElementById("confToChain").textContent = data.toChain;
    document.getElementById("confAmount").textContent = `${formatNumber(data.sendAmount)} ${data.fromChain}`;
    document.getElementById("confEscrow").textContent = escrowAddresses[data.fromChain] || "N/A";
    document.getElementById("confMemo").textContent = memoId || "N/A";

    document.getElementById("confFromChainLogo").src = getLogo(data.fromChain);
    document.getElementById("confToChainLogo").src = getLogo(data.toChain);

    // Show memo row only if applicable
    if (!chainsUsingMemo.includes(data.fromChain)) {
      document.getElementById("memoRow").style.display = "none";
    } else {
      document.getElementById("memoRow").style.display = "block";
    }

    // User info box
    const userInfoBox = document.getElementById("userInfoBox");
    if (data.userReceiveAddress) {
      userInfoBox.style.display = "block";
      document.getElementById("confFee").textContent = `${formatNumber(data.bridgeFee)} ${data.fromChain}`;
      const netReceived = (data.sendAmount - data.bridgeFee).toFixed(8);
      document.getElementById("confNetReceived").textContent = `${formatNumber(netReceived)} ${data.toChain}`;
      document.getElementById("userReceiveAddress").textContent = data.userReceiveAddress;
      if (chainsUsingMemo.includes(data.toChain)) {
        document.getElementById("userMemoId").textContent = data.userMemoId || "N/A";
        document.getElementById("userMemoRow").style.display = "block";
      } else {
        document.getElementById("userMemoRow").style.display = "none";
      }
    } else {
      userInfoBox.style.display = "none";
    }

    // Generate QR code for deposit address + memo if applicable
    generateQRCode(escrowAddresses[data.fromChain], "qrCodeContainer", data.fromChain, memoId);
  }

  async function main() {
    const memoId = getMemoId();

    if (!memoId) {
      alert("No memoId found in URL. Please access this page with a valid memoId.");
      return;
    }

    // Set confirmation URL in saveLinkWidget
    const confirmUrlInput = document.getElementById("confirmationUrl");
    confirmUrlInput.value = window.location.href;

    // Toggle save link popup
    document.getElementById("saveLinkBtn").addEventListener("click", () => {
      const popup = document.getElementById("saveLinkPopup");
      popup.classList.toggle("hidden");
    });

    // Replace this with your actual bridge fetch API
    // For demo, we simulate fetching a bridge record using the memoId
    // Sample data
    const bridgeData = {
      fromChain: "XRP",
      toChain: "XLM",
      sendAmount: 123.45678901,
      bridgeFee: 0.0001,
      userReceiveAddress: "GB3JDWC7N4PKURTZDDMYYWQY2RDRLUXR2TVWT6C6WJZTY7LBW5Z56HD7",
      userMemoId: "9876543210"
    };

    displayBridgeInfo(bridgeData, memoId);

    // Fetch bridge status and update status + countdown
    const statusInfo = await fetchBridgeStatus(memoId);
    const statusEl = document.getElementById("bridgeStatus");
    statusEl.textContent = statusInfo.status.charAt(0).toUpperCase() + statusInfo.status.slice(1);

    updateCountdown(statusInfo.expiresAt);
  }

  main();
</script>

</body>
</html>
