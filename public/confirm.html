<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/qrcode/build/qrcode.min.js"></script>
  <title>Bridge Confirmation</title>
  <style>
    body {
      background: #000 url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1350&q=80') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      font-family: sans-serif;
      padding: 2rem;
    }
    .form-box {
      background: rgba(17,17,17,0.9);
      padding: 2rem;
      max-width: 600px;
      margin: auto;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(30,144,255, 0.7);
    }
    .info-box {
      background: rgba(0, 0, 0, 0.6);
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 0 10px rgba(30,144,255,0.5);
    }
    button.copy-btn {
      background: #1e90ff;
      border: none;
      padding: 0.2rem 0.5rem;
      margin-left: 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      color: #fff;
      font-size: 1rem;
      vertical-align: middle;
    }
    button.copy-btn:hover {
      background: #1c7ddb;
    }
    #saveLinkWidget {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 999;
    }
    #saveLinkBtn {
      background: #1e90ff;
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(30,144,255,0.6);
    }
    #saveLinkPopup {
      background: rgba(0, 0, 0, 0.9);
      color: white;
      border-radius: 6px;
      padding: 0.75rem;
      width: 260px;
      margin-top: 8px;
      box-shadow: 0 0 10px rgba(0,255,255,0.2);
    }
    #saveLinkPopup input {
      width: 100%;
      padding: 0.25rem;
      margin-bottom: 0.5rem;
      border-radius: 4px;
      border: 1px solid #444;
      background: #111;
      color: #00ffff;
      font-size: 0.9rem;
    }
    #saveLinkPopup.hidden {
      display: none;
    }
  </style>
</head>
<body>
<div id="saveLinkWidget">
  <button id="saveLinkBtn" title="Click to show/save your confirmation link">🔗</button>
  <div id="saveLinkPopup" class="hidden">
    <p><strong>Remember to copy this link:</strong></p>
    <input type="text" id="confirmationUrl" readonly />
    <button class="copy-btn" onclick="copyToClipboard('confirmationUrl')">📋</button>
    <p style="font-size: 0.75rem; color: #aaa;">Bookmark or save this link to return here later.</p>
  </div>
</div>

<div class="form-box">
  <h2>Bridge Confirmation</h2>
  <p><strong>From Chain:</strong> <img id="confFromChainLogo" style="height:24px; vertical-align:middle;"> <span id="confFromChain"></span></p>
  <p><strong>To Chain:</strong> <img id="confToChainLogo" style="height:24px; vertical-align:middle;"> <span id="confToChain"></span></p>
  <p><strong>Send:</strong> <span id="confAmount"></span></p>
  <p><strong>Deposit Address:</strong> <span id="confEscrow" style="word-break: break-word;"></span> <button class="copy-btn" onclick="copyToClipboard('confEscrow')">📋 Copy</button></p>
  <p id="memoRow"><strong>Memo ID / Tag:</strong> <span id="confMemo"></span> <button class="copy-btn" onclick="copyToClipboard('confMemo')">📋 Copy</button></p>
  <p><strong>Status:</strong> <span id="bridgeStatus">Fetching...</span></p>
  <p><strong>Expires In:</strong> <span id="countdownTimer">—</span></p>
  <p><strong>Bridge Finalizes In:</strong> <span id="finalizeTimer">—</span></p>
</div>

<div class="info-box" id="userInfoBox" style="display:none;">
  <h3>Your Information</h3>
  <p><strong>Bridge Fee:</strong> <span id="confFee"></span></p>
  <p><strong>Net Received:</strong> <span id="confNetReceived"></span></p>
  <p><strong>Receive Address:</strong> <span id="userReceiveAddress"></span></p>
  <p id="userMemoRow"><strong>Memo ID / Tag:</strong> <span id="userMemoId"></span></p>
</div>

<div id="qrCodeContainer" style="margin-top: 10px;"></div>

<script>
  const chainsUsingMemo = ["XRP", "XLM", "HBAR"];
  let countdownInterval, finalizeInterval;

  function copyToClipboard(id) {
    const text = document.getElementById(id).textContent;
    navigator.clipboard.writeText(text).then(() => alert("Copied!"));
  }

  function formatCountdown(seconds) {
    const hrs = String(Math.floor(seconds / 3600)).padStart(2, "0");
    const mins = String(Math.floor((seconds % 3600) / 60)).padStart(2, "0");
    const secs = String(seconds % 60).padStart(2, "0");
    return `${hrs}:${mins}:${secs}`;
  }

  function getMemoId() {
    return new URLSearchParams(window.location.search).get("memoId");
  }

  function generateQRCode(address, elementId, fromChain, memoId) {
    const uriMap = {
      XRP: `xrp:${address}?dt=${memoId}`,
      XLM: `stellar:${address}?memo=${memoId}`,
      HBAR: `hedera:${address}?memo=${memoId}`,
      ALGO: `algo:${address}`,
      FLR: `flare:${address}`,
      XDC: `xdc:${address}`
    };
    const uri = uriMap[fromChain] || address;
    document.getElementById(elementId).innerHTML = "";
    new QRCode(elementId, { text: uri, width: 128, height: 128 });
  }

  function getLogo(chain) {
    const logos = {
      XRP: "https://altcoinsbox.com/wp-content/uploads/2023/01/xrp-logo-1140x1140.webp",
      HBAR: "https://altcoinsbox.com/wp-content/uploads/2023/03/hedera-logo-1140x1140.webp",
      FLR: "https://s2.coinmarketcap.com/static/img/coins/64x64/7950.png",
      XDC: "https://cdn.coincircle.com/icons/fallback/xdc-network.png",
      XLM: "https://files.swissborg.com/product/wealth-app/assets/ic_crypto_xlm.png",
      ALGO: "https://cdn.freelogovectors.net/wp-content/uploads/2021/10/algorand-logo-freelogovectors.net_.png"
    };
    return logos[chain] || "";
  }

  async function fetchBridgeData() {
    const memoId = getMemoId();
    if (!memoId) return;

    try {
      const res = await fetch(`/api/bridge-status?memoId=${memoId}`);
      const data = await res.json();

      document.getElementById("confFromChain").textContent = data.fromChain;
      document.getElementById("confToChain").textContent = data.toChain;
      document.getElementById("confAmount").textContent = `${data.amount} ${data.category || data.fromChain}`;
      document.getElementById("confFromChainLogo").src = getLogo(data.fromChain);
      document.getElementById("confToChainLogo").src = getLogo(data.toChain);
      document.getElementById("confFee").textContent = `- ${data.fee || "0.2"}`;
      document.getElementById("confNetReceived").textContent = `${data.amount - (data.fee || 0.2)}`;
      document.getElementById("confEscrow").textContent = data.escrow || "N/A";
      document.getElementById("confMemo").textContent = memoId;
      document.getElementById("userReceiveAddress").textContent = data.receiveAddress || "";

      const showMemo = chainsUsingMemo.includes(data.fromChain);
      document.getElementById("memoRow").style.display = showMemo ? "block" : "none";
      document.getElementById("userMemoRow").style.display = showMemo ? "block" : "none";
      document.getElementById("userMemoId").textContent = memoId;

      document.getElementById("bridgeStatus").textContent = {
        pending: "Pending confirmation...",
        confirmed: "Confirmed ✅",
        bridged: "Bridged 🌉",
        expired: "Expired ❌"
      }[data.status] || "Pending";

      generateQRCode(data.escrow, "qrCodeContainer", data.fromChain, memoId);

      if (countdownInterval) clearInterval(countdownInterval);
      if (finalizeInterval) clearInterval(finalizeInterval);

      if (["expired", "confirmed", "bridged"].includes(data.status)) {
        document.getElementById("countdownTimer").textContent = data.status === "expired" ? "Expired" : "—";
      } else if (data.expiresIn > 0) {
        let timeLeft = data.expiresIn;
        document.getElementById("countdownTimer").textContent = formatCountdown(timeLeft);
        countdownInterval = setInterval(() => {
          timeLeft--;
          if (timeLeft <= 0) {
            clearInterval(countdownInterval);
            document.getElementById("countdownTimer").textContent = "Expired";
            document.getElementById("bridgeStatus").textContent = "Expired ❌";
          } else {
            document.getElementById("countdownTimer").textContent = formatCountdown(timeLeft);
          }
        }, 1000);
      }

      if (data.status === "confirmed") {
        let finalizeLeft = 7200;
        document.getElementById("finalizeTimer").textContent = formatCountdown(finalizeLeft);
        finalizeInterval = setInterval(() => {
          finalizeLeft--;
          if (finalizeLeft <= 0) {
            clearInterval(finalizeInterval);
            document.getElementById("finalizeTimer").textContent = "Finalized ✅";
          } else {
            document.getElementById("finalizeTimer").textContent = formatCountdown(finalizeLeft);
          }
        }, 1000);
      } else {
        document.getElementById("finalizeTimer").textContent = "—";
      }
    } catch (err) {
      document.getElementById("bridgeStatus").textContent = "Error loading data";
      console.error("Fetch failed", err);
    }
  }

  document.getElementById("saveLinkBtn").addEventListener("click", () => {
    document.getElementById("saveLinkPopup").classList.toggle("hidden");
  });

  function setConfirmationLink() {
    const memoId = getMemoId();
    if (!memoId) return;
    document.getElementById("confirmationUrl").value = `${window.location.origin}${window.location.pathname}?memoId=${memoId}`;
  }

  setConfirmationLink();
  fetchBridgeData();
  setInterval(fetchBridgeData, 30000);
</script>
</body>
</html>
