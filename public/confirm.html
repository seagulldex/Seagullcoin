<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <script src="https://unpkg.com/qrcode/build/qrcode.min.js"></script>
  <title>Bridge Confirmation</title>
  <style>
    body { 
      background: #000 url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1350&q=80') no-repeat center center fixed; 
      background-size: cover;
      color: #fff; 
      font-family: sans-serif; 
      padding: 2rem; 
    }
    .form-box { 
      background: rgba(17,17,17,0.9); 
      padding: 2rem; 
      max-width: 600px; 
      margin: auto; 
      border-radius: 8px; 
      box-shadow: 0 0 15px rgba(30,144,255, 0.7); 
    }
    .info-box {
      background: rgba(0, 0, 0, 0.6);
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 0 10px rgba(30,144,255,0.5);
    }
    button.copy-btn {
      background: #1e90ff;
      border: none;
      padding: 0.2rem 0.5rem;
      margin-left: 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      color: #fff;
      font-size: 1rem;
      vertical-align: middle;
    }
    button.copy-btn:hover {
      background: #1c7ddb;
    }
  </style>
</head>
<body>
  <div class="form-box">
    <h2>Bridge Confirmation</h2>
    <p><strong>From Chain:</strong> <span id="confFromChain"></span></p>
    <p><strong>To Chain:</strong> <span id="confToChain"></span></p>
    <p><strong>Send:</strong> <span id="confAmount"></span></p>
    <p><strong>Deposit Address:</strong> 
      <span id="confEscrow" style="word-break: break-word;"></span>
      <button class="copy-btn" onclick="copyToClipboard('confEscrow')">üìã Copy</button>
    </p>
    <p><strong>Memo ID / Tag:</strong> 
      <span id="confMemo" style="color: #1e90ff;"></span>
      <button class="copy-btn" onclick="copyToClipboard('confMemo')">üìã Copy</button>
    </p>
    <p><strong>Status:</strong> <span id="bridgeStatus">Fetching...</span></p>
    <p><strong>Expires in:</strong> <span id="countdownTimer">‚Äî</span></p>
  </div>

  <div class="info-box" id="userInfoBox" style="display:none;">
    <h3>Your Information</h3>
    <p><strong>Receive Address:</strong> <span id="userReceiveAddress" style="word-break: break-word;"></span></p>
    <p><strong>Memo ID / Tag:</strong> <span id="userMemoId" style="color: #1e90ff;"></span></p>
  </div>

  <div id="qrCodeContainer" style="margin-top: 10px;"></div>
  
<script type="text/javascript">
  window.$crisp = [];
  window.CRISP_WEBSITE_ID = "c4c177f3-5bf9-4f53-8a57-5ed64696616e"; // üîÅ Replace with your actual Crisp ID
  (function () {
    const d = document;
    const s = d.createElement("script");
    s.src = "https://client.crisp.chat/l.js";
    s.async = 1;
    d.getElementsByTagName("head")[0].appendChild(s);
  })();
<script>
  const escrowAddresses = {
    XRP: "rU3y41mnPFxRhVLxdsCRDGbE2LAkVPEbLV",
    XLM: "GD2VMYH62JD2ZGTMMWFCU5YNMASC5NWZ5FM5WN2GWLYAACYXP6BKG44I",
    HBAR: "0.0.2928384",
    ALGO: "YFZD6UWU5KXQINAN4CV6UCMIMRFSTKXNFQWV7WUSYQIWASCH2AX4LT4RMM",
    FLR: "0x3B51F488f729e5Cfa566990Fd7f069F364b6984D",
    XDC: "xdc870f64E73e7D2dc5022b4b74e58C323b3148A984"
  };

  function copyToClipboard(id) {
    const text = document.getElementById(id).textContent;
    navigator.clipboard.writeText(text).then(() => {
      alert('Copied to clipboard!');
    });
  }

  function getMemoId() {
    return new URL(window.location.href).searchParams.get("memoId");
  }

  function generateQRCode(address, elementId, fromChain, memoId) {
    const container = document.getElementById(elementId);
    container.innerHTML = ""; // Clear previous QR

    let uri;

    switch (fromChain) {
      case "XRP":
        uri = `xrp:${address}?dt=${memoId}`;
        break;
      case "XLM":
        uri = `stellar:${address}?memo=${memoId}`;
        break;
      case "HBAR":
        uri = `hedera:${address}?memo=${memoId}`;
        break;
      case "ALGO":
        uri = `algo:${address}`;
        break;
      case "FLR":
        uri = `flare:${address}`;
        break;
      case "XDC":
        uri = `xdc:${address}`;
        break;
      default:
        uri = address; // fallback
    }

    new QRCode(container, {
      text: uri,
      width: 128,
      height: 128,
    });
  }

  function formatCountdown(seconds) {
    const hrs = Math.floor(seconds / 3600).toString().padStart(2, '0');
    const mins = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
    const secs = (seconds % 60).toString().padStart(2, '0');
    return `${hrs}:${mins}:${secs}`;
  }

  let countdownInterval;

  async function fetchBridgeData() {
    const memoId = getMemoId();
    if (!memoId) {
      document.getElementById("bridgeStatus").textContent = "No transaction specified.";
      document.getElementById("countdownTimer").textContent = "‚Äî";
      return;
    }

    try {
      const res = await fetch(`/api/bridge-status?memoId=${memoId}`);
      const data = await res.json();

      if (!res.ok) throw new Error(data.error || "Failed to fetch");

      // Update main UI
      document.getElementById("confFromChain").textContent = data.fromChain || "N/A";
      document.getElementById("confToChain").textContent = data.toChain || "N/A";

      const currencyLabel = data.category 
        ? `${data.category} (${data.fromChain})` 
        : `${data.fromChain}`;

      document.getElementById("confAmount").textContent = `${data.amount || "0"} ${currencyLabel}`;

      // Safely generate QR code only if address and memoId are valid
const escrow = escrowAddresses[data.fromChain];
const container = document.getElementById("qrCodeContainer");
container.innerHTML = "";
if (escrow && memoId) {
  try {
    generateQRCode(escrow, "qrCodeContainer", data.fromChain, memoId);
  } catch (qrErr) {
    console.error("QR code generation failed:", qrErr);
    container.innerHTML = "";
  }
} else {
  container.innerHTML = "";
}



      document.getElementById("confMemo").textContent = memoId;
      document.getElementById("confEscrow").textContent = escrow || "N/A";

      // Show user info box with receive address and memoId
      if (data.receiveAddress) {
        document.getElementById("userReceiveAddress").textContent = data.receiveAddress;
        document.getElementById("userMemoId").textContent = memoId;
        document.getElementById("userInfoBox").style.display = "block";
      } else {
        document.getElementById("userInfoBox").style.display = "none";
      }

      // Status handling
      if (data.status === "expired") {
        document.getElementById("bridgeStatus").textContent = "Expired. Please start a new transaction.";
        document.getElementById("countdownTimer").textContent = "Expired";
        clearInterval(countdownInterval);
        return;
      } else {
        document.getElementById("bridgeStatus").textContent = data.status || "Pending";
      }

      // Countdown timer
      if (countdownInterval) clearInterval(countdownInterval);
      if (data.expiresIn && data.expiresIn > 0) {
        let remaining = data.expiresIn;
        document.getElementById("countdownTimer").textContent = formatCountdown(remaining);

        countdownInterval = setInterval(() => {
          remaining--;
          if (remaining <= 0) {
            clearInterval(countdownInterval);
            document.getElementById("bridgeStatus").textContent = "Expired. Please start a new transaction.";
            document.getElementById("countdownTimer").textContent = "Expired";
          } else {
            document.getElementById("countdownTimer").textContent = formatCountdown(remaining);
          }
        }, 1000);
      } else {
        document.getElementById("countdownTimer").textContent = "‚Äî";
      }

    } catch (err) {
      document.getElementById("bridgeStatus").textContent = "Error loading transaction.";
      document.getElementById("countdownTimer").textContent = "‚Äî";
      console.error(err);
    }
  }

  async function pollStatus() {
    await fetchBridgeData();
    setTimeout(pollStatus, 30000);
  }

  pollStatus();
</script>
</body>
</html>
