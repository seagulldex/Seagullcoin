<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/qrcode/build/qrcode.min.js"></script>
  <title>Bridge Confirmation</title>
  <style>
    body { 
      background: #000 url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1350&q=80') no-repeat center center fixed; 
      background-size: cover;
      color: #fff; 
      font-family: sans-serif; 
      padding: 2rem; 
    }
    .form-box { 
      background: rgba(17,17,17,0.9); 
      padding: 2rem; 
      max-width: 600px; 
      margin: auto; 
      border-radius: 8px; 
      box-shadow: 0 0 15px rgba(30,144,255, 0.7); 
    }
    .info-box {
      background: rgba(0, 0, 0, 0.6);
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 0 10px rgba(30,144,255,0.5);
    }
    button.copy-btn {
      background: #1e90ff;
      border: none;
      padding: 0.2rem 0.5rem;
      margin-left: 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      color: #fff;
      font-size: 1rem;
      vertical-align: middle;
      transition: background-color 0.3s ease;
    }
    button.copy-btn:hover {
      background: #1c7ddb;
    }
    #saveLinkWidget {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 999;
    }
    #saveLinkBtn {
      background: #1e90ff;
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(30,144,255,0.6);
      transition: background-color 0.3s ease;
    }
    #saveLinkBtn:hover {
      background: #1c7ddb;
    }
    #saveLinkPopup {
      background: rgba(0, 0, 0, 0.9);
      color: white;
      border-radius: 6px;
      padding: 0.75rem;
      width: 260px;
      margin-top: 8px;
      box-shadow: 0 0 10px rgba(0,255,255,0.2);
    }
    #saveLinkPopup input {
      width: 100%;
      padding: 0.25rem;
      margin-bottom: 0.5rem;
      border-radius: 4px;
      border: 1px solid #444;
      background: #111;
      color: #00ffff;
      font-size: 0.9rem;
      user-select: all;
    }
    #saveLinkPopup.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div id="saveLinkWidget">
    <button id="saveLinkBtn" title="Click to show/save your confirmation link">ðŸ”—</button>
    <div id="saveLinkPopup" class="hidden">
      <p style="margin: 0 0 0.5rem;"><strong>Remember to copy this link:</strong></p>
      <input type="text" id="confirmationUrl" readonly />
      <button class="copy-btn" onclick="copyToClipboard('confirmationUrl')">ðŸ“‹</button>
      <p style="font-size: 0.75rem; color: #aaa;">Bookmark or save this link to return here later.</p>
    </div>
  </div>

  <div class="form-box">
    <h2>Bridge Confirmation</h2>
    
    <p>
      <strong>From Chain:</strong> 
      <img id="confFromChainLogo" alt="From Chain Logo" style="height:24px; vertical-align:middle; margin-right:6px;"/>
      <span id="confFromChain">Loading...</span>
    </p>
    <p>
      <strong>To Chain:</strong> 
      <img id="confToChainLogo" alt="To Chain Logo" style="height:24px; vertical-align:middle; margin-right:6px;"/>
      <span id="confToChain">Loading...</span>
    </p>
    <p><strong>Send:</strong> <span id="confAmount">Loading...</span></p>
    <p><strong>Deposit Address:</strong> 
      <span id="confEscrow" style="word-break: break-word;">Loading...</span>
      <button class="copy-btn" onclick="copyToClipboard('confEscrow')">ðŸ“‹ Copy</button>
    </p>
    <p id="memoRow"><strong>Memo ID / Tag:</strong> 
      <span id="confMemo" style="color: #1e90ff;">â€”</span>
      <button class="copy-btn" onclick="copyToClipboard('confMemo')">ðŸ“‹ Copy</button>
    </p>
    <p><strong>Status:</strong> <span id="bridgeStatus">Fetching...</span></p>
    <p><strong>Expires in:</strong> <span id="countdownTimer">â€”</span></p>
  </div>

  <div class="info-box" id="userInfoBox" style="display:none;">
    <h3>Your Information</h3>
    <p><strong>Bridge Fee:</strong> <span id="confFee" style="color: #ff4d4d;"></span></p>
    <p><strong>Net Received:</strong> <span id="confNetReceived" style="color: #00ffcc;"></span></p>
    <p><strong>Receive Address:</strong> <span id="userReceiveAddress" style="word-break: break-word;"></span></p>
    <p id="userMemoRow"><strong>Memo ID / Tag:</strong> <span id="userMemoId" style="color: #1e90ff;">â€”</span></p>
  </div>

  <div id="qrCodeContainer" style="margin-top: 10px;"></div>

  <script type="text/javascript">
    window.$crisp = [];
    window.CRISP_WEBSITE_ID = "c4c177f3-5bf9-4f53-8a57-5ed64696616e"; // Replace with your actual Crisp ID
    (function () {
      const d = document;
      const s = d.createElement("script");
      s.src = "https://client.crisp.chat/l.js";
      s.async = 1;
      d.getElementsByTagName("head")[0].appendChild(s);
    })();
  </script>

  <script>
    let modalDismissedForever = false;
    let countdownInterval;

    const escrowAddresses = {
      XRP: "rU3y41mnPFxRhVLxdsCRDGbE2LAkVPEbLV",
      XLM: "GD2VMYH62JD2ZGTMMWFCU5YNMASC5NWZ5FM5WN2GWLYAACYXP6BKG44I",
      HBAR: "0.0.2928384",
      ALGO: "YFZD6UWU5KXQINAN4CV6UCMIMRFSTKXNFQWV7WUSYQIWASCH2AX4LT4RMM",
      FLR: "0x3B51F488f729e5Cfa566990Fd7f069F364b6984D",
      XDC: "xdc870f64E73e7D2dc5022b4b74e58C323b3148A984"
    };

    const chainsUsingMemo = ["XRP", "XLM", "HBAR"];

    function copyToClipboard(id) {
      const text = document.getElementById(id).textContent.trim();
      if (!text || text === "â€”" || text === "Loading...") {
        alert("Nothing to copy!");
        return;
      }
      navigator.clipboard.writeText(text).then(() => {
        alert('Copied to clipboard!');
      }).catch(() => {
        alert('Failed to copy!');
      });
    }

    function getMemoId() {
      return new URL(window.location.href).searchParams.get("memoId");
    }

    function generateQRCode(address, elementId, fromChain, memoId) {
      const container = document.getElementById(elementId);
      container.innerHTML = ""; // Clear previous QR

      let uri;

      switch (fromChain) {
        case "XRP":
          uri = `xrp:${address}${memoId ? `?dt=${memoId}` : ''}`;
          break;
        case "XLM":
          uri = `stellar:${address}${memoId ? `?memo=${memoId}` : ''}`;
          break;
        case "HBAR":
          uri = `hedera:${address}${memoId ? `?memo=${memoId}` : ''}`;
          break;
        case "ALGO":
          uri = `algo:${address}`;
          break;
        case "FLR":
          uri = `flare:${address}`;
          break;
        case "XDC":
          uri = `xdc:${address}`;
          break;
        default:
          uri = address;
          break;
      }

      QRCode.toCanvas(uri, { width: 150 }, function (error, canvas) {
        if (error) {
          console.error(error);
          container.innerHTML = "<p style='color:red;'>QR Code failed to generate.</p>";
          return;
        }
        container.appendChild(canvas);
      });
    }

    function getFromChainLogoUrl(chain) {
      switch (chain.toUpperCase()) {
        case "XRP": return "https://cryptologos.cc/logos/xrp-xrp-logo.svg?v=024";
        case "XLM": return "https://cryptologos.cc/logos/stellar-xlm-logo.svg?v=024";
        case "HBAR": return "https://cryptologos.cc/logos/hedera-hbar-logo.svg?v=024";
        case "ALGO": return "https://cryptologos.cc/logos/algorand-algo-logo.svg?v=024";
        case "FLR": return "https://cryptologos.cc/logos/flare-flr-logo.svg?v=024";
        case "XDC": return "https://cryptologos.cc/logos/xinfin-xdc-logo.svg?v=024";
        default: return "";
      }
    }

    function displayBridgeData() {
      const urlParams = new URLSearchParams(window.location.search);
      const fromChain = urlParams.get("fromChain") || "N/A";
      const toChain = urlParams.get("toChain") || "N/A";
      const amount = urlParams.get("amount") || "N/A";
      const fee = urlParams.get("fee") || "0";
      const escrow = urlParams.get("escrow") || escrowAddresses[fromChain] || "N/A";
      const status = urlParams.get("status") || "Pending";
      const receiveAddress = urlParams.get("receiveAddress") || "N/A";
      const memoId = getMemoId() || null;

      const netReceived = (parseFloat(amount) - parseFloat(fee)).toFixed(6);

      // Populate UI
      document.getElementById("confFromChain").textContent = fromChain;
      document.getElementById("confToChain").textContent = toChain;
      document.getElementById("confAmount").textContent = amount;
      document.getElementById("confFee").textContent = `${fee} ${fromChain}`;
      document.getElementById("confNetReceived").textContent = `${netReceived} ${toChain}`;
      document.getElementById("confEscrow").textContent = escrow;
      document.getElementById("bridgeStatus").textContent = status;
      document.getElementById("userReceiveAddress").textContent = receiveAddress;

      document.getElementById("confFromChainLogo").src = getFromChainLogoUrl(fromChain);
      document.getElementById("confToChainLogo").src = getFromChainLogoUrl(toChain);

      if (chainsUsingMemo.includes(fromChain.toUpperCase())) {
        document.getElementById("memoRow").style.display = "block";
        document.getElementById("confMemo").textContent = memoId || "â€”";
        document.getElementById("userMemoRow").style.display = "block";
        document.getElementById("userMemoId").textContent = memoId || "â€”";
      } else {
        document.getElementById("memoRow").style.display = "none";
        document.getElementById("userMemoRow").style.display = "none";
      }

      // Show user info box
      document.getElementById("userInfoBox").style.display = "block";

      generateQRCode(escrow, "qrCodeContainer", fromChain, memoId);

      // Set confirmation URL in save link widget
      const currentUrl = window.location.href;
      document.getElementById("confirmationUrl").value = currentUrl;
    }

    function copyToClipboard(id) {
      const el = document.getElementById(id);
      let text;
      if (el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
        text = el.value;
      } else {
        text = el.textContent;
      }
      if (!text || text === "â€”" || text === "Loading...") {
        alert("Nothing to copy!");
        return;
      }
      navigator.clipboard.writeText(text).then(() => {
        alert("Copied to clipboard!");
      }).catch(() => {
        alert("Copy failed. Try manually.");
      });
    }

    function startCountdown(durationSeconds) {
      const countdownElem = document.getElementById("countdownTimer");
      let remaining = durationSeconds;

      function updateTimer() {
        if (remaining <= 0) {
          clearInterval(countdownInterval);
          countdownElem.textContent = "Expired";
          return;
        }
        const mins = Math.floor(remaining / 60);
        const secs = remaining % 60;
        countdownElem.textContent = `${mins}m ${secs}s`;
        remaining--;
      }
      updateTimer();
      countdownInterval = setInterval(updateTimer, 1000);
    }

    function toggleSaveLinkPopup() {
      const popup = document.getElementById("saveLinkPopup");
      popup.classList.toggle("hidden");
    }

    document.getElementById("saveLinkBtn").addEventListener("click", toggleSaveLinkPopup);

    // Initialization
    displayBridgeData();
    startCountdown(20 * 60); // 20 minutes countdown

  </script>
</body>
</html>
