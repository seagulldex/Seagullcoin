<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bridge Confirmation</title>
  <style>
    body { background: #000; color: #fff; font-family: sans-serif; padding: 2rem; }
    .form-box { background: #111; padding: 2rem; max-width: 600px; margin: auto; border-radius: 8px; box-shadow: 0 0 15px rgba(30,144,255, 0.3); }
  </style>
</head>
<body>
  <div class="form-box">
    <h2>Bridge Confirmation</h2>
    <p><strong>From Chain:</strong> <span id="confFromChain"></span></p>
    <p><strong>To Chain:</strong> <span id="confToChain"></span></p>
    <p><strong>Send:</strong> <span id="confAmount"></span></p>
    <p><strong>To Address:</strong> <span id="confEscrow" style="word-break: break-word;"></span></p>
    <p><strong>Memo ID / Tag:</strong> <span id="confMemo" style="color: #1e90ff;"></span></p>
    <p><strong>Status:</strong> <span id="bridgeStatus">Fetching...</span></p>
    <p><strong>Expires in:</strong> <span id="countdownTimer">—</span></p>
  </div>

  <script>
    const escrowAddresses = {
      XRP: "rU3y41mnPFxRhVLxdsCRDGbE2LAkVPEbLV",
      XLM: "GD2VMYH62JD2ZGTMMWFCU5YNMASC5NWZ5FM5WN2GWLYAACYXP6BKG44I",
      HBAR: "0.0.2928384",
      ALGO: "YFZD6UWU5KXQINAN4CV6UCMIMRFSTKXNFQWV7WUSYQIWASCH2AX4LT4RMM",
      FLR: "0x3B51F488f729e5Cfa566990Fd7f069F364b6984D",
      XDC: "xdc870f64E73e7D2dc5022b4b74e58C323b3148A984"
    };

  // Helper: get query param from URL
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  // Format seconds as mm:ss
  function formatTime(seconds) {
    const m = Math.floor(seconds / 60).toString().padStart(2, '0');
    const s = (seconds % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
  }

  async function fetchBridgeDetails(memoId) {
    try {
      const res = await fetch(`/api/transaction/${memoId}`);
      if (!res.ok) throw new Error('Transaction not found or expired');

      const data = await res.json();

      // Update the confirmation fields
      document.getElementById('confFromChain').textContent = data.fromChain;
      document.getElementById('confToChain').textContent = data.toChain;
      document.getElementById('confAmount').textContent = `${data.amount} ${data.fromChain}`;
      document.getElementById('confEscrow').textContent = data.receiveAddress;
      document.getElementById('confMemo').textContent = memoId;

      // Show status
      if (data.status === 'expired') {
        document.getElementById('bridgeStatus').textContent = 'Expired. Please start a new transaction.';
        document.getElementById('countdownTimer').textContent = 'Expired';
        return;
      } else {
        document.getElementById('bridgeStatus').textContent = data.status || 'Pending';
      }

      // Handle expiration countdown if expiration time provided
      if (data.expiresAt) {
        const expiresAt = new Date(data.expiresAt).getTime();

        const timerInterval = setInterval(() => {
          const now = Date.now();
          const diff = Math.floor((expiresAt - now) / 1000);

          if (diff <= 0) {
            clearInterval(timerInterval);
            document.getElementById('bridgeStatus').textContent = 'Expired. Please start a new transaction.';
            document.getElementById('countdownTimer').textContent = 'Expired';
          } else {
            document.getElementById('countdownTimer').textContent = formatTime(diff);
          }
        }, 1000);
      } else {
        document.getElementById('countdownTimer').textContent = '—';
      }

    } catch (err) {
      console.error(err);
      document.getElementById('bridgeStatus').textContent = 'Error fetching transaction.';
      document.getElementById('countdownTimer').textContent = '—';
    }
  }

  // On page load
  const memoId = getQueryParam('memoId');
  if (memoId) {
    fetchBridgeDetails(memoId);
  } else {
    document.getElementById('bridgeStatus').textContent = 'No transaction specified.';
    document.getElementById('countdownTimer').textContent = '—';
  }

    function getMemoId() {
      const url = new URL(window.location.href);
      return url.searchParams.get("memoId");
    }

    async function fetchBridgeData() {
      const memoId = getMemoId();
      if (!memoId) {
        alert("Missing memoId");
        return;
      }

      try {
        const res = await fetch(`/api/bridge-status?memoId=${memoId}`);
        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || "Failed to fetch");
        }

        document.getElementById("confFromChain").textContent = data.fromChain;
        document.getElementById("confToChain").textContent = data.toChain;
        document.getElementById("confAmount").textContent = data.amount;
        document.getElementById("confMemo").textContent = memoId;
        document.getElementById("confEscrow").textContent = escrowAddresses[data.fromChain] || "N/A";
        document.getElementById("bridgeStatus").textContent = data.status;

        startCountdown(data.expiresIn);
      } catch (err) {
        document.getElementById("bridgeStatus").textContent = "Error loading transaction.";
        console.error(err);
      }
    }

    async function pollStatus() {
      await fetchBridgeData();
      setTimeout(pollStatus, 30000); // Poll every 30 seconds
    }

    pollStatus();

    function startCountdown(seconds) {
      const timerEl = document.getElementById("countdownTimer");
      let remaining = seconds;

      const interval = setInterval(() => {
        if (remaining <= 0) {
          clearInterval(interval);
<script>
  const escrowAddresses = {
    XRP: "rU3y41mnPFxRhVLxdsCRDGbE2LAkVPEbLV",
    XLM: "GD2VMYH62JD2ZGTMMWFCU5YNMASC5NWZ5FM5WN2GWLYAACYXP6BKG44I",
    HBAR: "0.0.2928384",
    ALGO: "YFZD6UWU5KXQINAN4CV6UCMIMRFSTKXNFQWV7WUSYQIWASCH2AX4LT4RMM",
    FLR: "0x3B51F488f729e5Cfa566990Fd7f069F364b6984D",
    XDC: "xdc870f64E73e7D2dc5022b4b74e58C323b3148A984"
  };

  function getMemoId() {
    return new URL(window.location.href).searchParams.get("memoId");
  }

  function formatCountdown(seconds) {
    const hrs = Math.floor(seconds / 3600).toString().padStart(2, '0');
    const mins = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
    const secs = (seconds % 60).toString().padStart(2, '0');
    return `${hrs}:${mins}:${secs}`;
  }

  let countdownInterval;

  async function fetchBridgeData() {
    const memoId = getMemoId();
    if (!memoId) {
      document.getElementById("bridgeStatus").textContent = "No transaction specified.";
      document.getElementById("countdownTimer").textContent = "—";
      return;
    }

    try {
      const res = await fetch(`/api/bridge-status?memoId=${memoId}`);
      const data = await res.json();

      if (!res.ok) throw new Error(data.error || "Failed to fetch");

      // Update UI
      document.getElementById("confFromChain").textContent = data.fromChain || "N/A";
      document.getElementById("confToChain").textContent = data.toChain || "N/A";
      document.getElementById("confAmount").textContent = `${data.amount || "0"} ${data.fromChain || ""}`;
      document.getElementById("confMemo").textContent = memoId;
      document.getElementById("confEscrow").textContent = data.receiveAddress || escrowAddresses[data.fromChain] || "N/A";

      // Status
      if (data.status === "expired") {
        document.getElementById("bridgeStatus").textContent = "Expired. Please start a new transaction.";
        document.getElementById("countdownTimer").textContent = "Expired";
        clearInterval(countdownInterval);
        return;
      } else {
        document.getElementById("bridgeStatus").textContent = data.status || "Pending";
      }

      // Countdown
      if (countdownInterval) clearInterval(countdownInterval);
      if (data.expiresIn && data.expiresIn > 0) {
        let remaining = data.expiresIn;
        document.getElementById("countdownTimer").textContent = formatCountdown(remaining);

        countdownInterval = setInterval(() => {
          remaining--;
          if (remaining <= 0) {
            clearInterval(countdownInterval);
            document.getElementById("bridgeStatus").textContent = "Expired. Please start a new transaction.";
            document.getElementById("countdownTimer").textContent = "Expired";
          } else {
            document.getElementById("countdownTimer").textContent = formatCountdown(remaining);
          }
        }, 1000);
      } else {
        document.getElementById("countdownTimer").textContent = "—";
      }

    } catch (err) {
      document.getElementById("bridgeStatus").textContent = "Error loading transaction.";
      document.getElementById("countdownTimer").textContent = "—";
      console.error(err);
    }
  }

  async function pollStatus() {
    await fetchBridgeData();
    setTimeout(pollStatus, 30000); // Poll every 30 seconds
  }

  // Start polling on page load
  pollStatus();
</script>
</body>
</html>
