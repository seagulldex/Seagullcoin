<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Messages - SGLCN-X20 NFT Minter</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="stylesheet" href="header.css"/>
  <script src="https://cdn.jsdelivr.net/npm/xumm-sdk/dist/xumm-sdk.bundle.js"></script>
<style>
  /* Additional scroll fix */
  .inbox {
    width: 250px;
    background: #fff;
    color: #000;
    border-radius: 10px;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid #ccc;
    max-height: 500px;
  }

  .inbox-message {
    padding: 10px;
    border-bottom: 1px solid #ccc;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .inbox-message:hover {
    background-color: #eee;
  }

  .unread-badge {
    background: red;
    color: white;
    border-radius: 10px;
    padding: 2px 6px;
    font-size: 0.8rem;
    margin-left: 5px;
  }

  .chat-box {
    flex: 1;
    background: #fff;
    color: #000;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    border: 1px solid #ccc;
  }

  .chat-log {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
  }

  .chat-entry.you {
    text-align: right;
    color: blue;
  }

  .chat-entry.them {
    text-align: left;
    color: black;
  }

  .chat-form textarea {
    flex: 1;
    height: 60px;
    background: #f9f9f9;
    color: #000;
    border: none;
    padding: 10px;
    resize: none;
  }

  .chat-form button {
    background: #007bff;
    color: white;
    border: none;
    padding: 0 20px;
    font-weight: bold;
    cursor: pointer;
  }

  .chat-form button:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
</style>

<script>
  let currentChatWith = null;
  const walletStatus = document.getElementById('wallet-container');
  const walletIndicator = document.getElementById('wallet-indicator');
  const sendButton = document.getElementById('send-button');
  const messageInput = document.getElementById('message-text');
  let socket = null;
  let myWallet = null;
  let unreadCounts = {};

  window.addEventListener('DOMContentLoaded', () => {
    updateWalletStatus();
    messageInput.addEventListener('input', () => {
      sendButton.disabled = !messageInput.value.trim() || !myWallet;
    });
  });

  walletStatus.addEventListener('click', () => {
    const wallet = localStorage.getItem('xumm_wallet_address');
    if (!wallet) {
      startLoginFlow();
    } else {
      window.location.href = `/profile.html?uuid=${JSON.parse(localStorage.getItem('xumm_user')).uuid}`;
    }
  });

  async function updateWalletStatus() {
    const wallet = localStorage.getItem('xumm_wallet_address');
    myWallet = wallet;

    if (wallet) {
      document.getElementById('wallet-info').style.display = 'block';
      document.getElementById('wallet-address').innerText = wallet;
      walletIndicator.textContent = 'ðŸŸ¢ Profile';
      walletIndicator.classList.remove('red');
      walletIndicator.classList.add('green');
      sendButton.disabled = !messageInput.value.trim();

      loadInbox(wallet);
      setupWebSocket(wallet);
    } else {
      walletIndicator.textContent = 'ðŸ”´ Login';
      walletIndicator.classList.remove('green');
      walletIndicator.classList.add('red');
      sendButton.disabled = true;
    }
  }

  async function startLoginFlow() {
    const res = await fetch('https://sglcn-x20-api.glitch.me/login');
    const data = await res.json();
    const payloadUUID = data.payloadUUID;

    window.open(data.payloadURL, "_blank");

    const interval = setInterval(async () => {
      const check = await fetch(`https://sglcn-x20-api.glitch.me/check-login?uuid=${payloadUUID}`);
      const loginStatus = await check.json();

      if (loginStatus.loggedIn) {
        clearInterval(interval);
        localStorage.setItem('xumm_wallet_address', loginStatus.account);
        localStorage.setItem('xumm_user', JSON.stringify(loginStatus));
        updateWalletStatus();
      }
    }, 3000);
  }

  async function loadInbox(wallet) {
    const res = await fetch(`https://sglcn-x20-api.glitch.me/get-message?wallet=${wallet}`);
    const messages = await res.json();
    const inbox = document.getElementById('inbox');
    inbox.innerHTML = '';
    unreadCounts = {};

    const contacts = [...new Set(messages.map(msg => msg.sender === wallet ? msg.recipient : msg.sender))];

    contacts.forEach(addr => {
      unreadCounts[addr] = messages.filter(m => m.sender === addr && !m.read).length;
    });

    contacts.forEach(addr => {
      const div = document.createElement('div');
      div.className = 'inbox-message';
      div.onclick = () => {
        unreadCounts[addr] = 0;
        loadConversation(wallet, addr);
      };

      const nameSpan = document.createElement('span');
      nameSpan.innerText = addr;

      const badge = document.createElement('span');
      if (unreadCounts[addr] > 0) {
        badge.className = 'unread-badge';
        badge.innerText = unreadCounts[addr];
      }

      div.appendChild(nameSpan);
      if (unreadCounts[addr] > 0) div.appendChild(badge);
      inbox.appendChild(div);
    });
  }

  async function loadConversation(user, other) {
    currentChatWith = other;
    const res = await fetch(`https://sglcn-x20-api.glitch.me/get-message?wallet=${user}`);
    const messages = await res.json();
    const chatLog = document.getElementById('chat-log');
    chatLog.innerHTML = '';

    const conversation = messages.filter(m => (m.sender === other && m.recipient === user) || (m.sender === user && m.recipient === other));
    conversation.forEach(msg => {
      const div = document.createElement('div');
      div.className = `chat-entry ${msg.sender === user ? 'you' : 'them'}`;
      div.innerText = msg.text;
      chatLog.appendChild(div);
    });

    chatLog.scrollTop = chatLog.scrollHeight;
  }

  async function sendMessage() {
    const wallet = myWallet;
    const text = messageInput.value.trim();
    if (!wallet || !currentChatWith || !text) return;

    await fetch("https://sglcn-x20-api.glitch.me/send-message", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sender: wallet, recipient: currentChatWith, text })
    });

    messageInput.value = '';
    sendButton.disabled = true;
    loadConversation(wallet, currentChatWith);
  }

  function setupWebSocket(wallet) {
    if (socket) socket.close();
    socket = new WebSocket(`wss://sglcn-x20-api.glitch.me/ws?wallet=${wallet}`);

    socket.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'message' && data.sender !== wallet) {
        if (data.sender === currentChatWith) {
          loadConversation(wallet, currentChatWith);
        } else {
          unreadCounts[data.sender] = (unreadCounts[data.sender] || 0) + 1;
          loadInbox(wallet);
        }
      }
    };
  }
  </script>