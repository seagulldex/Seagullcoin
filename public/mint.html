<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SGLCN-X20 Staking</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" />
  <style>
    .staking-section {
      max-width: 800px;
      margin: 2rem auto;
    }
    .green { color: green; }
    .red { color: red; }
  </style>
</head>
<body>
  <nav class="container-fluid">
    <ul>
      <li><strong>SGLCN-X20</strong></li>
    </ul>
    <ul>
      <li><a href="/" role="button" class="secondary">Home</a></li>
      <li><a href="/NFT.html" role="button" class="secondary">NFTs</a></li>
      <li><a href="#" id="wallet-indicator" class="red">ðŸ”´ Login</a></li>
    </ul>
  </nav>

  <main class="staking-section">
    <h2>Staking Dashboard</h2>
    <div id="wallet-info" style="display:none;">
      <p><strong>Wallet:</strong> <span id="wallet-address"></span></p>
      <p><strong>Balance:</strong> <span id="seagull-balance">-</span> SeagullCoin</p>
    </div>

    <hr />

    <div id="staking-controls">
      <h3>Staking Controls</h3>
      <p id="staking-status">Please connect your wallet to view staking options.</p>
      <button id="stake-btn" disabled>Stake 10 SGLCN</button>
      <button id="unstake-btn" disabled>Unstake</button>
    </div>

    <hr />

    <div id="rewards">
      <h3>Rewards History</h3>
      <ul id="rewards-list"></ul>
    </div>
  </main>

  <script>
    let wallet = null;

    // Load wallet from localStorage if available
    document.addEventListener('DOMContentLoaded', async () => {
      const stored = localStorage.getItem('xumm_user');
      if (stored) {
        try {
          const user = JSON.parse(stored);
          wallet = user?.account;
        } catch (err) {}
      }
      updateWalletUI();
    });

    function updateWalletUI() {
      const indicator = document.getElementById('wallet-indicator');
      if (wallet) {
        document.getElementById('wallet-info').style.display = 'block';
        document.getElementById('wallet-address').textContent = wallet;
        indicator.textContent = 'ðŸŸ¢ Profile';
        indicator.classList.remove('red');
        indicator.classList.add('green');
        indicator.title = 'Go to profile';
        indicator.onclick = () => {
          const user = JSON.parse(localStorage.getItem('xumm_user'));
          if (user?.uuid) {
            window.location.href = `/profile.html?uuid=${user.uuid}`;
          }
        };
        fetchSeagullCoinBalance(wallet);
        updateStakingUI();
      } else {
        document.getElementById('wallet-info').style.display = 'none';
        indicator.textContent = 'ðŸ”´ Login';
        indicator.classList.remove('green');
        indicator.classList.add('red');
        indicator.title = 'Click to login';
        indicator.onclick = () => startLoginFlow();
      }
    }

    async function fetchSeagullCoinBalance(account) {
      try {
        const res = await fetch(`https://s2.ripple.com:51234/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            method: 'account_lines',
            params: [{ account }]
          })
        });
        const data = await res.json();
        const lines = data?.result?.lines || [];
        const line = lines.find(l =>
          l.currency === '53656167756C6C436F696E000000000000000000' &&
          l.issuer === 'rnqiA8vuNriU9pqD1ZDGFH8ajQBL25Wkno'
        );
        document.getElementById('seagull-balance').textContent = line ? line.balance : '0.00';
      } catch (err) {
        document.getElementById('seagull-balance').textContent = 'Error';
      }
    }

    function updateStakingUI() {
      if (!wallet) {
        document.getElementById('staking-status').textContent = 'Please connect your wallet to stake.';
        document.getElementById('stake-btn').disabled = true;
        document.getElementById('unstake-btn').disabled = true;
        return;
      }

      document.getElementById('staking-status').textContent = 'Wallet connected. Staking is available.';
      document.getElementById('stake-btn').disabled = false;
      document.getElementById('unstake-btn').disabled = false;

      // Load rewards history (optional, dummy for now)
      document.getElementById('rewards-list').innerHTML = '<li>No rewards yet.</li>';
    }

    async function startLoginFlow() {
      try {
        const res = await fetch('/login');
        const { next, qr, uuid } = await res.json();
        const popup = window.open(qr, 'xumm', 'width=400,height=600');
        const interval = setInterval(async () => {
          const r = await fetch(`/login-status?uuid=${uuid}`);
          const status = await r.json();
          if (status?.account) {
            clearInterval(interval);
            popup?.close();
            localStorage.setItem('xumm_user', JSON.stringify({ uuid, account: status.account }));
            wallet = status.account;
            updateWalletUI();
          }
        }, 1500);
      } catch (e) {
        alert('Login failed.');
      }
    }

    document.getElementById('stake-btn').addEventListener('click', () => {
      if (!wallet) return alert('Connect your wallet first.');
      alert('Staking 10 SGLCN... (functionality coming soon)');
    });

    document.getElementById('unstake-btn').addEventListener('click', () => {
      if (!wallet) return alert('Connect your wallet first.');
      alert('Unstaking... (functionality coming soon)');
    });
  </script>
</body>
</html>
