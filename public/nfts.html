<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trading - SGLCN-X20</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="header.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    #timeframe-buttons {
      margin: 20px 0;
      display: flex;
      gap: 10px;
    }
    #timeframe-buttons button {
      background-color: #2196F3;
      padding: 8px 14px;
      font-size: 16px;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }
    #timeframe-buttons button.active {
      background-color: #0b7dda;
    }
    #timeframe-buttons button:hover:not(.active) {
      background-color: #45a049;
    }
    #wallet-status {
      cursor: pointer;
      user-select: none;
    }
    #wallet-indicator.red {
      color: red;
    }
    #wallet-indicator.green {
      color: green;
    }
    #logout-btn {
      display: none;
      background-color: #f44336;
      border: none;
      color: white;
      padding: 6px 12px;
      font-size: 14px;
      border-radius: 3px;
      cursor: pointer;
      margin-left: 10px;
    }
    #current-price {
      font-size: 1.5rem;
      margin-bottom: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="top-bar">
    <div style="flex:1;">
      <button id="logout-btn">Logout</button>
    </div>
    <div id="wallet-container">
      <div id="wallet-status">
        <span id="wallet-indicator" class="red">ðŸ”´ Login</span>
      </div>
    </div>
  </div>

  <header>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="stake.html">Stake</a></li>
        <li><a href="https://sglcn-x20-api.glitch.me/SeagullmansionsV2.html" target="_blank" rel="noopener noreferrer">SGLMN V2 (mint)</a></li>
      </ul>
    </nav>
  </header>

  <main style="padding: 20px;">
    <h1>Trading</h1>

    <h2>SGLCN/XRP Price Chart</h2>

    <div id="current-price">
      SGLCN / XRP Price: <span id="price-value">Loading...</span> XRP
    </div>

    <div id="timeframe-buttons">
      <button data-timeframe="1h" class="active">1 Hour</button>
      <button data-timeframe="6h">6 Hours</button>
      <button data-timeframe="24h">24 Hours</button>
      <button data-timeframe="7d">7 Days</button>
    </div>

    <canvas id="priceChart" style="max-width: 700px; width: 100%; height: 400px;"></canvas>
  </main>

  <script>
    // Wallet status update
    function updateWalletStatus() {
      const wallet = localStorage.getItem('xumm_wallet_address');
      const indicator = document.getElementById('wallet-indicator');
      const logoutBtn = document.getElementById('logout-btn');
      if (wallet) {
        indicator.textContent = 'ðŸŸ¢ Connected';
        indicator.classList.remove('red');
        indicator.classList.add('green');
        indicator.title = 'Logged in';
        indicator.onclick = null;
        logoutBtn.style.display = 'inline-block';
      } else {
        indicator.textContent = 'ðŸ”´ Login';
        indicator.classList.remove('green');
        indicator.classList.add('red');
        indicator.title = 'Click to login';
        indicator.onclick = startLoginFlow;
        logoutBtn.style.display = 'none';
      }
    }

    async function startLoginFlow() {
      try {
        const res = await fetch('https://sglcn-x20-api.glitch.me/login');
        if (!res.ok) throw new Error('Login API error');
        const data = await res.json();
        window.open(data.payloadURL, "_blank");

        const interval = setInterval(async () => {
          try {
            const check = await fetch(`https://sglcn-x20-api.glitch.me/check-login?uuid=${data.payloadUUID}`);
            const loginStatus = await check.json();
            if (loginStatus.loggedIn) {
              clearInterval(interval);
              localStorage.setItem('xumm_wallet_address', loginStatus.account);
              updateWalletStatus();
            }
          } catch (err) {
            console.error('Login status check error', err);
          }
        }, 3000);
      } catch (err) {
        alert('Failed to start login: ' + err.message);
      }
    }

    document.getElementById('logout-btn').onclick = () => {
      localStorage.removeItem('xumm_wallet_address');
      updateWalletStatus();
    };

    window.addEventListener('DOMContentLoaded', () => {
      updateWalletStatus();
      setupTimeframeButtons();
      updateChartForTimeframe('1h');
      updateCurrentPrice();
      setInterval(updateCurrentPrice, 60000); // refresh price every 60s
    });

    // Chart.js price chart setup
    const ctx = document.getElementById('priceChart').getContext('2d');

    const priceData = {
      labels: [],
      datasets: [{
        label: 'SGLCN to XRP',
        data: [],
        borderColor: 'rgb(33, 150, 243)',
        backgroundColor: 'rgba(33, 150, 243, 0.2)',
        fill: true,
        tension: 0.3,
      }]
    };

    const priceChart = new Chart(ctx, {
      type: 'line',
      data: priceData,
      options: {
        responsive: true,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: {
          legend: { display: true },
          tooltip: {
            mode: 'index',
            intersect: false,
          },
        },
        scales: {
          x: {
            type: 'time',
            time: {
              tooltipFormat: 'MMM d, HH:mm',
              unit: 'minute',
              displayFormats: {
                minute: 'HH:mm',
                hour: 'MMM d HH:mm',
                day: 'MMM d',
              }
            },
            title: { display: true, text: 'Time' },
          },
          y: {
            beginAtZero: false,
            title: { display: true, text: 'Price (XRP)' },
          }
        }
      }
    });

    async function fetchPriceData(timeframe) {
      try {
        const res = await fetch(`https://sglcn-x20-api.glitch.me/api/sglcn-xrp?timeframe=${timeframe}`);
        if (!res.ok) throw new Error('Network response was not ok');
        const data = await res.json();
        return data;
      } catch (error) {
        console.error('Failed to fetch price data:', error);
        return null;
      }
    }

    async function updateChartForTimeframe(tf) {
      let pricePoints = await fetchPriceData(tf);
      if (!pricePoints) {
        pricePoints = generateDummyData(
          tf === '1h' ? 60 : tf === '6h' ? 72 : tf === '24h' ? 96 : 168,
          tf === '1h' ? 1 : tf === '6h' ? 5 : tf === '24h' ? 15 : 60
        );
      }
      priceChart.data.labels = pricePoints.map(d => new Date(d.time));
      priceChart.data.datasets[0].data = pricePoints.map(d => Number(d.price));
      priceChart.options.scales.x.time.unit = (tf === '7d' || tf === '24h') ? 'hour' : 'minute';
      priceChart.update();
    }

    function generateDummyData(points, intervalMinutes) {
      const now = new Date();
      let data = [];
      for (let i = points - 1; i >= 0; i--) {
        const time = new Date(now.getTime() - i * intervalMinutes * 60 * 1000);
        const price = 0.00001 + 0.00001 * Math.sin(i / 5) + (Math.random() - 0.5) * 0.000002;
        data.push({ time: time.toISOString(), price: price.toFixed(8) });
      }
      return data;
    }

    function setupTimeframeButtons() {
      const buttons = document.querySelectorAll('#timeframe-buttons button');
      buttons.forEach(btn => {
        btn.onclick = () => {
          buttons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          updateChartForTimeframe(btn.dataset.timeframe);
        };
      });
    }

    async function updateCurrentPrice() {
      try {
        const res = await fetch('https://sglcn-x20-api.glitch.me/api/sglcn-xrp');
        if (!res.ok) throw new Error('Failed to fetch price');
        const data = await res.json();
        const priceValue = parseFloat(data.sglcn_to_xrp);
        if (!isNaN(priceValue)) {
          document.getElementById('price-value').textContent = priceValue.toFixed(6);
        } else {
          document.getElementById('price-value').textContent = 'N/A';
        }
      } catch (error) {
        console.error('Error updating price:', error);
        document.getElementById('price-value').textContent = 'Error';
      }
    }
  </script>
</body>
</html>
