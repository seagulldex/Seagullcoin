<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>XRP/SGLCN - Last 1 Hour Chart</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #111; color: #fff; }
    canvas { max-width: 100%; height: 400px; background: #fff; border-radius: 10px; }
  </style>
</head>
<body>
  <h2>XRP / SeagullCoin - Last 1 Hour Candlestick Chart</h2>
  <canvas id="chart" width="800" height="400"></canvas>

  <script>
    async function fetchTrades() {
      const response = await fetch('/get-trades');
      const data = await response.json();
      const oneHourAgo = Date.now() - (60 * 60 * 1000);

      // Filter trades from last 1 hour
      const recentTrades = data.trades.filter(trade => {
        const timestamp = new Date(trade.timestamp).getTime();
        return timestamp >= oneHourAgo;
      });

      // Bucket trades by minute
      const buckets = {};
      recentTrades.forEach(trade => {
        const date = new Date(trade.timestamp);
        const minute = new Date(date.getFullYear(), date.getMonth(), date.getDate(), date.getHours(), date.getMinutes());
        const key = minute.toISOString();

        if (!buckets[key]) {
          buckets[key] = {
            t: minute,
            o: trade.price,
            h: trade.price,
            l: trade.price,
            c: trade.price
          };
        } else {
          buckets[key].h = Math.max(buckets[key].h, trade.price);
          buckets[key].l = Math.min(buckets[key].l, trade.price);
          buckets[key].c = trade.price;
        }
      });

      return Object.values(buckets);
    }

    async function renderChart() {
      const candles = await fetchTrades();

      const ctx = document.getElementById('chart').getContext('2d');
      new Chart(ctx, {
        type: 'candlestick',
        data: {
          datasets: [{
            label: 'XRP / SGLCN',
            data: candles,
            color: {
              up: '#0f0',
              down: '#f00',
              unchanged: '#999'
            }
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              time: {
                unit: 'minute',
              },
              type: 'time',
              ticks: { color: '#fff' },
              grid: { color: '#333' }
            },
            y: {
              ticks: { color: '#fff' },
              grid: { color: '#333' }
            }
          }
        }
      });
    }

    renderChart();
  </script>
</body>
</html>
