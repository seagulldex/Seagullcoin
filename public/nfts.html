<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trading - SGLCN-X20</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    #timeframe-buttons {
      margin-bottom: 15px;
    }
    #timeframe-buttons button {
      margin-right: 8px;
      background-color: #2196F3;
      padding: 8px 12px;
      font-size: 16px;
      color: white;
      border: none;
      cursor: pointer;
    }
    #timeframe-buttons button.active {
      background-color: #0b7dda;
    }
    button:hover {
      background-color: #45a049;
    }
    .red { color: red; }
    .green { color: green; }
  </style>
</head>
<body>
  <div id="top-bar">
    <div style="flex:1;"><button id="logout-btn" style="display:none;">Logout</button></div>
    <div id="wallet-container">
      <div id="wallet-status">
        <span id="wallet-indicator" class="red">ðŸ”´ Login</span>
      </div>
    </div>
  </div>

  <header>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="stake.html">Stake</a></li>
        <li><a href="https://sglcn-x20-api.glitch.me/SeagullmansionsV2.html" target="_blank" rel="noopener noreferrer">SGLMN V2 (mint)</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <h1>Trading</h1>
    <h2>SGLCN/XRP Price Chart</h2>

    <div id="timeframe-buttons">
      <button data-timeframe="1h" class="active">1 Hour</button>
      <button data-timeframe="6h">6 Hours</button>
      <button data-timeframe="24h">24 Hours</button>
      <button data-timeframe="7d">7 Days</button>
    </div>

    <canvas id="priceChart" style="max-width: 700px; margin-bottom: 30px;"></canvas>
  </main>

  <script>
    // Wallet login status update (minimal)
    function updateWalletStatus() {
      const wallet = localStorage.getItem('xumm_wallet_address');
      const indicator = document.getElementById('wallet-indicator');
      if (wallet) {
        indicator.textContent = 'ðŸŸ¢ Connected';
        indicator.classList.replace('red', 'green');
        indicator.title = 'Logged in';
        document.getElementById('logout-btn').style.display = 'inline-block';
        indicator.onclick = null;
      } else {
        indicator.textContent = 'ðŸ”´ Login';
        indicator.classList.replace('green', 'red');
        indicator.title = 'Click to login';
        indicator.onclick = startLoginFlow;
        document.getElementById('logout-btn').style.display = 'none';
      }
    }

    async function startLoginFlow() {
      try {
        const res = await fetch('https://sglcn-x20-api.glitch.me/login');
        const data = await res.json();
        window.open(data.payloadURL, "_blank");

        const interval = setInterval(async () => {
          const check = await fetch(`https://sglcn-x20-api.glitch.me/check-login?uuid=${data.payloadUUID}`);
          const loginStatus = await check.json();
          if (loginStatus.loggedIn) {
            clearInterval(interval);
            localStorage.setItem('xumm_wallet_address', loginStatus.account);
            updateWalletStatus();
          }
        }, 3000);
      } catch (err) {
        console.error('Login failed', err);
      }
    }

    document.getElementById('logout-btn').onclick = () => {
      localStorage.removeItem('xumm_wallet_address');
      updateWalletStatus();
    };

    // Chart.js setup
    const ctx = document.getElementById('priceChart').getContext('2d');

    const priceData = {
      labels: [],
      datasets: [{
        label: 'SGLCN to XRP',
        data: [],
        borderColor: 'rgb(33, 150, 243)',
        backgroundColor: 'rgba(33, 150, 243, 0.2)',
        fill: true,
        tension: 0.3,
      }]
    };

    const priceChart = new Chart(ctx, {
      type: 'line',
      data: priceData,
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: true },
          tooltip: { mode: 'index', intersect: false }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              tooltipFormat: 'MMM d, HH:mm',
              unit: 'minute',
              displayFormats: {
                minute: 'HH:mm',
                hour: 'MMM d HH:mm',
                day: 'MMM d',
              }
            },
            title: { display: true, text: 'Time' },
          },
          y: {
            beginAtZero: false,
            title: { display: true, text: 'Price (XRP)' },
          }
        }
      }
    });

    // Fetch price data from API
    async function fetchPriceData(timeframe) {
      try {
        const url = `https://sglcn-x20-api.glitch.me/api/sglcn-xrp?timeframe=${timeframe}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Network response was not ok: ${res.status}`);
        const data = await res.json();
        // Validate data format:
        if (!Array.isArray(data)) throw new Error('API response is not an array');
        if (!data.length) throw new Error('API response is empty');
        if (!data[0].time || !data[0].price) throw new Error('API response missing time or price fields');
        return data;
      } catch (error) {
        console.error('Failed to fetch price data:', error);
        return null;
      }
    }

    async function updateChartForTimeframe(tf) {
      let pricePoints = await fetchPriceData(tf);
      if (!pricePoints) {
        pricePoints = generateDummyData(
          tf === '1h' ? 60 : tf === '6h' ? 72 : tf === '24h' ? 96 : 168,
          tf === '1h' ? 1 : tf === '6h' ? 5 : tf === '24h' ? 15 : 60
        );
      }
      priceChart.data.labels = pricePoints.map(d => new Date(d.time));
      priceChart.data.datasets[0].data = pricePoints.map(d => Number(d.price));
      priceChart.options.scales.x.time.unit = (tf === '7d' || tf === '24h') ? 'hour' : 'minute';
      priceChart.update();
    }

    // Dummy fallback data generator
    function generateDummyData(points, intervalMinutes) {
      const now = new Date();
      let data = [];
      for (let i = points - 1; i >= 0; i--) {
        const time = new Date(now.getTime() - i * intervalMinutes * 60000);
        const price = 0.00001 + 0.00001 * Math.sin(i / 5) + (Math.random() - 0.5) * 0.000002;
        data.push({ time: time.toISOString(), price: price.toFixed(8) });
      }
      return data;
    }

    function setupTimeframeButtons() {
      const buttons = document.querySelectorAll('#timeframe-buttons button');
      buttons.forEach(btn => {
        btn.onclick = () => {
          buttons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          updateChartForTimeframe(btn.dataset.timeframe);
        };
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      updateWalletStatus();
      setupTimeframeButtons();
      updateChartForTimeframe('1h');
    });
  </script>
</body>
</html>
