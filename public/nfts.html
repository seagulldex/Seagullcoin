<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User NFTs - SGLCN-X20</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="stylesheet" href="header.css" />
  <style>
    .pagination { margin-top: 20px; text-align: center; }
    .pagination button { margin: 0 5px; padding: 5px 10px; }
    #page-controls { margin: 15px 0; text-align: right; }
    .nft-card, .collection-card {
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .nft-card img, .collection-card img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
    }
    .nft-grid, .collection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
      padding: 15px 0;
    }
    .nft-card button { margin: 5px; }
    #back-btn { margin: 10px 0; display: none; }
    }
    
    #search-bar {
  padding: 8px;
  font-size: 16px;
  width: 540px;
}

button {
  padding: 8px 12px;
  font-size: 16px;
  background-color: #4CAF50;
  color: white;
  border: none;
  cursor: pointer;
}

button:hover {
  background-color: #45a049;
}

  </style>
</head>
<body>
  <div id="top-bar">
    <div style="flex:1;"><button id="logout-btn">Logout</button></div>
    <div id="wallet-container">
      <div id="wallet-status">
        <span id="wallet-indicator" class="red">üî¥ Login</span>
      </div>
    </div>
  </div>

  <header>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="nfts.html">NFTs</a></li>
        <li><a href="mint.html">Mint NFT</a></li>
        <li><a href="messages.html">Messages</a></li>
      </ul>
    </nav>
  </header>
  
<input type="text" id="search-bar" placeholder="Search for NFTs..." oninput="handleSearchInput(event)" />
  <button onclick="searchNFTs()">Search</button>
  
  <main>
    <h1>NFTs</h1>
    <div id="loading-spinner">
      <img src="https://media.giphy.com/media/U3qYN8S0j3bpK/giphy.gif" alt="Loading Seagull" class="seagull-spinner">
      <p>Loading your NFTs...</p>
    </div>

    <button id="back-btn">‚Üê Back to Collections</button>

    <div id="nft-container" class="collection-grid" style="display:none;"></div>
    <div class="pagination" id="pagination"></div>
  </main>
<script>
  function convertIPFSToURL(ipfsUrl) {
    if (!ipfsUrl) return "";
    return ipfsUrl.startsWith("ipfs://")
      ? "https://cloudflare-ipfs.com/ipfs/" + ipfsUrl.slice(7)
      : ipfsUrl;
  }

  let allNFTs = [];
  let collectionMap = {};
  let nftsPerPage = 50;
  let currentPage = 1;

  window.addEventListener('DOMContentLoaded', () => {
    updateWalletStatus();
    document.getElementById('back-btn').onclick = showCollections;
  });

  function updateWalletStatus() {
    const wallet = localStorage.getItem('xumm_wallet_address');
    const indicator = document.getElementById('wallet-indicator');
    if (wallet) {
      indicator.textContent = 'üü¢ Connected';
      indicator.classList.replace('red', 'green');
      indicator.title = 'Logged in';
      document.getElementById('logout-btn').style.display = 'inline-block';
      fetchNFTs(wallet);
    } else {
      indicator.textContent = 'üî¥ Login';
      indicator.classList.replace('green', 'red');
      indicator.title = 'Click to login';
      indicator.onclick = startLoginFlow;
    }
  }

  async function startLoginFlow() {
    const res = await fetch('https://sglcn-x20-api.glitch.me/login');
    const data = await res.json();
    window.open(data.payloadURL, "_blank");

    const interval = setInterval(async () => {
      const check = await fetch(`https://sglcn-x20-api.glitch.me/check-login?uuid=${data.payloadUUID}`);
      const loginStatus = await check.json();
      if (loginStatus.loggedIn) {
        clearInterval(interval);
        localStorage.setItem('xumm_wallet_address', loginStatus.account);
        updateWalletStatus();
      }
    }, 3000);
  }

  async function fetchNFTs(wallet) {
    document.getElementById('loading-spinner').style.display = 'block';
    document.getElementById('nft-container').style.display = 'none';
    try {
      const res = await fetch(`https://sglcn-x20-api.glitch.me/catalog`);
      const data = await res.json();
      allNFTs = (data.nfts || []).filter(nft => nft.metadata && nft.metadata.name && nft.metadata.image);
      collectionMap = groupByCollection(allNFTs);
      showCollections();
    } catch (err) {
      console.error("Error loading NFTs:", err);
    } finally {
      document.getElementById('loading-spinner').style.display = 'none';
    }
  }

  function groupByCollection(nfts) {
    const map = {};
    for (const nft of nfts) {
      const collection = nft.metadata.collection || 'Uncategorized';
      if (!map[collection]) map[collection] = [];
      map[collection].push(nft);
    }
    return map;
  }

  function showCollections() {
    document.getElementById('back-btn').style.display = 'none';
    const container = document.getElementById('nft-container');
    container.innerHTML = "";
    container.className = 'collection-grid';
    container.style.display = 'grid';
    for (const [collection, items] of Object.entries(collectionMap)) {
      const logo = convertIPFSToURL(items[0].metadata.logo || items[0].metadata.image);
      const card = document.createElement('div');
      card.className = 'collection-card';
      card.innerHTML = `
        <img src="${logo}" alt="${collection}" />
        <h3>${collection}</h3>
        <p>${items.length} NFT(s)</p>
      `;
      card.onclick = () => showNFTsInCollection(collection);
      container.appendChild(card);
    }
  }

  function showNFTsInCollection(collection) {
    const container = document.getElementById('nft-container');
    container.innerHTML = "";
    container.className = 'nft-grid';
    const items = collectionMap[collection];
    for (const nft of items) {
      const metadata = nft.metadata;
      const card = document.createElement('div');
      card.className = 'nft-card';
      card.innerHTML = `
        <img src="${convertIPFSToURL(metadata.image)}" alt="${metadata.name}" />
        <h3>${metadata.name}</h3>
        <p>${metadata.description || ""}</p>
      `;

      const sellBtn = document.createElement('button');
      sellBtn.textContent = 'Sell';
      sellBtn.onclick = async () => {
        const amount = prompt("Enter price in SeagullCoin:");
        if (!amount) return;
        const response = await fetch("/sell-nft", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            walletAddress: localStorage.getItem("xumm_wallet_address"),
            nftId: nft.NFTokenID,
            price: amount
          }),
        });
        const result = await response.json();
        if (result.next) window.open(result.next.always, "_blank");
        else alert("Error creating sell offer.");
      };

      const transferBtn = document.createElement('button');
      transferBtn.textContent = 'Transfer';
      transferBtn.onclick = () => alert('Transfer functionality for ' + metadata.name);

      card.appendChild(sellBtn);
      card.appendChild(transferBtn);
      container.appendChild(card);
    }
    document.getElementById('back-btn').style.display = 'inline-block';
  }

  document.getElementById('logout-btn').onclick = () => {
    localStorage.removeItem('xumm_wallet_address');
    location.reload();
  };

  // Function to handle search
  function searchNFTs() {
    const query = document.getElementById('search-bar').value.toLowerCase();
    if (!query) {
      showCollections();
      return;
    }

    const filteredNFTs = allNFTs.filter(nft => 
      nft.metadata.name.toLowerCase().includes(query) ||
      (nft.metadata.description && nft.metadata.description.toLowerCase().includes(query))
    );

    collectionMap = groupByCollection(filteredNFTs);
    showCollections();
  }
</script>
</body>
</html>
